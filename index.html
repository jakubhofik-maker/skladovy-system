<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pozn√°mky - Aplikace</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .auth-card h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-primary:hover:not(:disabled) {
            opacity: 0.9;
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .success-message {
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .auth-link {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .auth-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .notes-container {
            min-height: 100vh;
            padding: 20px;
        }

        .notes-header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notes-header h1 {
            color: #333;
            margin-bottom: 5px;
        }

        .user-email {
            color: #666;
            font-size: 14px;
        }

        .btn-logout {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
        }

        .notes-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .add-note-form {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .note-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 15px;
        }

        .btn-add {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .notes-list {
            display: grid;
            gap: 15px;
        }

        .note-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
            border-left: 4px solid #667eea;
        }

        .note-content {
            flex: 1;
        }

        .note-text {
            color: #333;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }

        .note-date {
            color: #999;
            font-size: 12px;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .hidden {
            display: none;
        }

        .tab-btn {
            padding: 10px 20px;
            background: #f0f0f0;
            color: #666;
            border: none;
            border-radius: 8px 8px 0 0;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 5px;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-btn:hover {
            background: #e0e0e0;
        }

        .user-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-info h3 {
            color: #333;
            margin-bottom: 5px;
        }

        .user-email-text {
            color: #666;
            font-size: 14px;
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .role-user {
            background: #e3f2fd;
            color: #1976d2;
        }

        .role-moderator {
            background: #fff3e0;
            color: #f57c00;
        }

        .role-admin {
            background: #fce4ec;
            color: #c2185b;
        }

        .user-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-role {
            background: #667eea;
            color: white;
        }

        .btn-reset {
            background: #ff9800;
            color: white;
        }

        .btn-role:hover, .btn-reset:hover {
            opacity: 0.9;
        }

        select {
            padding: 6px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .stock-status {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #667eea;
        }

        .stock-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stock-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stock-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stock-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="auth-container">
        <div class="auth-card">
            <h1>P≈ôihl√°≈°en√≠</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label>P≈ôezd√≠vka:</label>
                    <input type="text" id="loginEmail" required placeholder="Zadejte p≈ôezd√≠vku">
                </div>
                <div class="form-group">
                    <label>Heslo:</label>
                    <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div id="loginError" class="error-message hidden"></div>
                <button type="submit" class="btn-primary">P≈ôihl√°sit se</button>
            </form>
            <p class="auth-link">
                Nem√°te √∫ƒçet? <a href="#" id="showRegister">Registrovat se</a>
            </p>
        </div>
    </div>

    <!-- Register Screen -->
    <div id="registerScreen" class="auth-container hidden">
        <div class="auth-card">
            <h1>Registrace</h1>
            <form id="registerForm">
                <div class="form-group">
                    <label>P≈ôezd√≠vka:</label>
                    <input type="text" id="registerEmail" required placeholder="Zadejte p≈ôezd√≠vku">
                </div>
                <div class="form-group">
                    <label>Heslo:</label>
                    <input type="password" id="registerPassword" required placeholder="Minim√°lnƒõ 6 znak≈Ø">
                </div>
                <div class="form-group">
                    <label>Potvrdit heslo:</label>
                    <input type="password" id="registerPasswordConfirm" required placeholder="Zadejte heslo znovu">
                </div>
                <div id="registerError" class="error-message hidden"></div>
                <button type="submit" class="btn-primary">Registrovat se</button>
            </form>
            <p class="auth-link">
                Ji≈æ m√°te √∫ƒçet? <a href="#" id="showLogin">P≈ôihl√°sit se</a>
            </p>
        </div>
    </div>

    <!-- Waiting for Role Screen (pro u≈æivatele bez role) -->
    <div id="waitingForRoleScreen" class="notes-container hidden">
        <div class="notes-header">
            <div>
                <h1>ƒåek√°n√≠ na p≈ôi≈ôazen√≠ role</h1>
                <p class="user-email" id="waitingUserEmail"></p>
            </div>
            <div>
                <button id="waitingLogoutBtn" class="btn-logout">Odhl√°sit se</button>
            </div>
        </div>
        <div class="notes-content">
            <div class="empty-state" style="padding: 80px 20px;">
                <div style="font-size: 64px; margin-bottom: 20px;">‚è≥</div>
                <h2 style="color: #333; margin-bottom: 15px;">ƒåek√°te na p≈ôi≈ôazen√≠ role</h2>
                <p style="color: #666; font-size: 16px; line-height: 1.6; max-width: 500px; margin: 0 auto;">
                    V√°≈° √∫ƒçet byl √∫spƒõ≈°nƒõ vytvo≈ôen, ale zat√≠m nem√°te p≈ôi≈ôazenou roli.<br>
                    Pros√≠m, poƒçkejte, a≈æ v√°m administr√°tor nebo moder√°tor p≈ôi≈ôad√≠ roli.<br>
                    Po p≈ôi≈ôazen√≠ role budete m√≠t p≈ô√≠stup k aplikaci.
                </p>
            </div>
        </div>
    </div>

    <!-- Sklad Screen -->
    <div id="notesScreen" class="notes-container hidden">
        <div class="notes-header">
            <div>
                <h1>Sklad</h1>
                <p class="user-email" id="userEmail"></p>
            </div>
            <div>
                <button id="salaryBtn" class="btn-secondary" style="background: #4caf50;">üí∞ V√Ωplata</button>
                <button id="sendDiscordOverviewBtn" class="btn-secondary" style="background: #5865F2;">üìä P≈ôehled na Discord</button>
                <button id="myTransactionsBtn" class="btn-secondary">Moje transakce</button>
                <button id="adminBtn" class="btn-secondary hidden">Admin panel</button>
                <button id="changePasswordBtn" class="btn-secondary">Zmƒõnit heslo</button>
                <button id="logoutBtn" class="btn-logout">Odhl√°sit se</button>
            </div>
        </div>

        <div class="notes-content">
            <!-- Aktu√°ln√≠ stav skladu -->
            <div class="stock-status">
                <h2 style="color: #333; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">Aktu√°lnƒõ na skladƒõ:</h2>
                <div class="stock-items">
                    <div class="stock-item">
                        <div class="stock-label">Pen√≠ze:</div>
                        <div class="stock-value" id="stockMoney">0</div>
                    </div>
                    <div class="stock-item">
                        <div class="stock-label">Koka-listky:</div>
                        <div class="stock-value" id="stockTickets">0</div>
                    </div>
                    <div class="stock-item">
                        <div class="stock-label">S√°ƒçky:</div>
                        <div class="stock-value" id="stockBags">0</div>
                    </div>
                </div>
            </div>

            <!-- Formul√°≈ô pro operace se skladem -->
            <form id="stockForm" class="add-note-form">
                <h3 style="color: #333; margin-bottom: 15px;">Sklad - Vz√≠t / Ulo≈æit <span id="adminSetLabel" class="hidden">/ Nastavit</span></h3>
                <div class="form-group">
                    <label>Typ polo≈æky:</label>
                    <select id="stockItemType" class="note-input" required>
                        <option value="">Vyberte polo≈æku</option>
                        <option value="money">Pen√≠ze</option>
                        <option value="tickets">Koka-listky</option>
                        <option value="bags">S√°ƒçky</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Operace:</label>
                    <select id="stockOperation" class="note-input" required>
                        <option value="">Vyberte operaci</option>
                        <option value="add">Ulo≈æit</option>
                        <option value="remove">Vz√≠t</option>
                        <option id="adminSetOption" value="set" class="hidden">Nastavit na hodnotu (admin)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="stockAmountLabel">Poƒçet:</label>
                    <input type="number" id="stockAmount" class="note-input" min="0" step="1" required placeholder="Zadejte poƒçet">
                </div>
                <div class="form-group">
                    <label>Pozn√°mka (voliteln√©):</label>
                    <input type="text" id="stockNote" class="note-input" placeholder="Nap≈ô. V√Ωplata, N√°kup materi√°lu...">
                </div>
                <button type="submit" class="btn-add">Potvrdit</button>
            </form>
        </div>
    </div>

    <!-- Moje transakce Screen -->
    <div id="myTransactionsScreen" class="notes-container hidden">
        <div class="notes-header">
            <div>
                <h1>Moje transakce</h1>
                <p class="user-email" id="myTransactionsUserEmail"></p>
            </div>
            <div>
                <button id="backToSkladBtn" class="btn-secondary">Zpƒõt na sklad</button>
                <button id="myTransactionsLogoutBtn" class="btn-logout">Odhl√°sit se</button>
            </div>
        </div>

        <div class="notes-content">
            <!-- Filtry pro u≈æivatele -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 12px; margin-bottom: 5px; display: block;">Filtr podle typu:</label>
                    <select id="userFilterType" class="note-input" style="padding: 8px; font-size: 14px;" onchange="applyUserFilters()">
                        <option value="">V≈°echny typy</option>
                        <option value="money">Pen√≠ze</option>
                        <option value="tickets">Koka-listky</option>
                        <option value="bags">S√°ƒçky</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 12px; margin-bottom: 5px; display: block;">Filtr podle data:</label>
                    <select id="userFilterDate" class="note-input" style="padding: 8px; font-size: 14px;" onchange="applyUserFilters()">
                        <option value="">V≈°echna data</option>
                        <option value="today">Dnes</option>
                        <option value="week">Tento t√Ωden</option>
                        <option value="month">Tento mƒõs√≠c</option>
                        <option value="custom">Vlastn√≠ rozsah</option>
                    </select>
                </div>
                <div id="userCustomDateRange" class="form-group" style="margin-bottom: 0; display: none; grid-column: span 2;">
                    <label style="font-size: 12px; margin-bottom: 5px; display: block;">Vlastn√≠ rozsah:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="date" id="userFilterDateFrom" class="note-input" style="padding: 8px; font-size: 14px;" onchange="applyUserFilters()">
                        <input type="date" id="userFilterDateTo" class="note-input" style="padding: 8px; font-size: 14px;" onchange="applyUserFilters()">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 12px; margin-bottom: 5px; display: block;">Vyhled√°v√°n√≠:</label>
                    <input type="text" id="userSearch" class="note-input" style="padding: 8px; font-size: 14px;" placeholder="Hledat v pozn√°mk√°ch..." oninput="applyUserFilters()">
                </div>
                <div style="display: flex; align-items: flex-end; gap: 10px;">
                    <button onclick="clearUserFilters()" class="btn-small" style="flex: 1; background: #999; color: white;">Zru≈°it filtry</button>
                    <button onclick="exportMyTransactionsToCSV()" class="btn-small" style="flex: 1; background: #4caf50; color: white;">Export CSV</button>
                </div>
            </div>
            
            <div id="myTransactionsList" class="notes-list"></div>
            <div id="myTransactionsPagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Zmƒõna hesla Screen -->
    <div id="changePasswordScreen" class="auth-container hidden">
        <div class="auth-card">
            <h1>Zmƒõna hesla</h1>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label>Souƒçasn√© heslo:</label>
                    <input type="password" id="currentPassword" required placeholder="Zadejte souƒçasn√© heslo">
                </div>
                <div class="form-group">
                    <label>Nov√© heslo:</label>
                    <input type="password" id="newPassword" required placeholder="Minim√°lnƒõ 6 znak≈Ø" minlength="6">
                </div>
                <div class="form-group">
                    <label>Potvrzen√≠ nov√©ho hesla:</label>
                    <input type="password" id="newPasswordConfirm" required placeholder="Zadejte nov√© heslo znovu" minlength="6">
                </div>
                <div id="changePasswordError" class="error-message hidden"></div>
                <div id="changePasswordSuccess" class="success-message hidden"></div>
                <button type="submit" class="btn-primary">Zmƒõnit heslo</button>
            </form>
            <button id="backToSkladFromPasswordBtn" class="btn-secondary" style="margin-top: 15px; width: 100%;">Zpƒõt na sklad</button>
        </div>
    </div>

    <!-- Salary Modal -->
    <div id="salaryModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="color: #333; margin-bottom: 20px; text-align: center;">üí∞ Moje v√Ωplata</h2>
            <div id="salaryContent" style="margin-bottom: 20px;">
                <!-- Obsah bude naƒçten dynamicky -->
            </div>
            <button onclick="closeSalaryModal()" class="btn-primary" style="width: 100%;">Zav≈ô√≠t</button>
        </div>
    </div>

    <!-- Admin Screen -->
    <div id="adminScreen" class="notes-container hidden">
        <div class="notes-header">
            <div>
                <h1>Administraƒçn√≠ panel</h1>
                <p class="user-email">P≈ôehled historie transakc√≠ a u≈æivatel≈Ø</p>
            </div>
            <div>
                <button id="backToNotesBtn" class="btn-secondary">Sklad</button>
                <button id="adminLogoutBtn" class="btn-logout">Odhl√°sit se</button>
            </div>
        </div>

        <div class="notes-content">
            <div id="adminStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                    <h3 style="color: #666; font-size: 14px; margin-bottom: 10px;">Celkem transakc√≠</h3>
                    <p id="totalNotes" style="color: #667eea; font-size: 36px; font-weight: bold; margin: 0;">0</p>
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                    <h3 style="color: #666; font-size: 14px; margin-bottom: 10px;">Poƒçet u≈æivatel≈Ø</h3>
                    <p id="totalUsers" style="color: #667eea; font-size: 36px; font-weight: bold; margin: 0;">0</p>
                </div>
            </div>

            <!-- Tabs pro admin panel -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0;">
                <button id="adminTabDashboard" class="tab-btn" onclick="showAdminTab('dashboard')">Dashboard</button>
                <button id="adminTabNotes" class="tab-btn active" onclick="showAdminTab('notes')">Historie</button>
                <button id="adminTabRoles" class="tab-btn" onclick="showAdminTab('roles')" style="display: none;">Spr√°va rol√≠</button>
                <button id="adminTabUsers" class="tab-btn" onclick="showAdminTab('users')" style="display: none;">Spr√°va u≈æivatel≈Ø</button>
            </div>

            <!-- Sekce Dashboard -->
            <div id="adminDashboardSection" style="display: none;">
                <h2 style="color: #333; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">Statistiky a p≈ôehled</h2>
                
                <div id="dashboardContent">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <h3 style="color: #666; font-size: 14px; margin-bottom: 10px;">Celkem transakc√≠</h3>
                            <p id="dashboardTotalTransactions" style="color: #667eea; font-size: 36px; font-weight: bold; margin: 0;">0</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <h3 style="color: #666; font-size: 14px; margin-bottom: 10px;">Aktivn√≠ch u≈æivatel≈Ø</h3>
                            <p id="dashboardActiveUsers" style="color: #667eea; font-size: 36px; font-weight: bold; margin: 0;">0</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <h3 style="color: #666; font-size: 14px; margin-bottom: 10px;">Transakc√≠ dnes</h3>
                            <p id="dashboardTodayTransactions" style="color: #667eea; font-size: 36px; font-weight: bold; margin: 0;">0</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <h3 style="color: #666; font-size: 14px; margin-bottom: 10px;">Transakc√≠ tento t√Ωden</h3>
                            <p id="dashboardWeekTransactions" style="color: #667eea; font-size: 36px; font-weight: bold; margin: 0;">0</p>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <h3 style="color: #333; margin-bottom: 15px;">Nejaktivnƒõj≈°√≠ u≈æivatel√©</h3>
                            <div id="dashboardTopUsers"></div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <h3 style="color: #333; margin-bottom: 15px;">Rozdƒõlen√≠ podle typu</h3>
                            <div id="dashboardByType"></div>
                        </div>
                    </div>

                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h3 style="color: #333; margin-bottom: 15px;">Aktivity podle dne (posledn√≠ch 7 dn√≠)</h3>
                        <div id="dashboardActivityChart" style="min-height: 200px;"></div>
                    </div>
                </div>
            </div>

            <!-- Sekce Historie transakc√≠ -->
            <div id="adminNotesSection">
                <h2 style="color: #333; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">Historie transakc√≠</h2>
                
                <!-- Filtry pro admin panel -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px; margin-bottom: 5px; display: block;">Filtr podle u≈æivatele:</label>
                        <select id="adminFilterUser" class="note-input" style="padding: 8px; font-size: 14px;" onchange="applyAdminFilters()">
                            <option value="">V≈°ichni u≈æivatel√©</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px; margin-bottom: 5px; display: block;">Filtr podle typu:</label>
                        <select id="adminFilterType" class="note-input" style="padding: 8px; font-size: 14px;" onchange="applyAdminFilters()">
                            <option value="">V≈°echny typy</option>
                            <option value="money">Pen√≠ze</option>
                            <option value="tickets">Koka-listky</option>
                            <option value="bags">S√°ƒçky</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px; margin-bottom: 5px; display: block;">Filtr podle data:</label>
                        <select id="adminFilterDate" class="note-input" style="padding: 8px; font-size: 14px;" onchange="applyAdminFilters()">
                            <option value="">V≈°echna data</option>
                            <option value="today">Dnes</option>
                            <option value="week">Tento t√Ωden</option>
                            <option value="month">Tento mƒõs√≠c</option>
                            <option value="custom">Vlastn√≠ rozsah</option>
                        </select>
                    </div>
                    <div id="customDateRange" class="form-group" style="margin-bottom: 0; display: none; grid-column: span 2;">
                        <label style="font-size: 12px; margin-bottom: 5px; display: block;">Vlastn√≠ rozsah:</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="date" id="adminFilterDateFrom" class="note-input" style="padding: 8px; font-size: 14px;" onchange="applyAdminFilters()">
                            <input type="date" id="adminFilterDateTo" class="note-input" style="padding: 8px; font-size: 14px;" onchange="applyAdminFilters()">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px; margin-bottom: 5px; display: block;">Vyhled√°v√°n√≠:</label>
                        <input type="text" id="adminSearch" class="note-input" style="padding: 8px; font-size: 14px;" placeholder="Hledat v pozn√°mk√°ch..." oninput="applyAdminFilters()">
                    </div>
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <button onclick="clearAdminFilters()" class="btn-small" style="flex: 1; background: #999; color: white;">Zru≈°it filtry</button>
                        <button onclick="exportToCSV()" class="btn-small" style="flex: 1; background: #4caf50; color: white;">Export CSV</button>
                    </div>
                </div>
                
                <div id="adminNotesList" class="notes-list"></div>
            </div>

            <!-- Sekce Spr√°va rol√≠ (pouze pro adminy a moder√°tory) -->
            <div id="adminRolesSection" style="display: none;">
                <h2 style="color: #333; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">Spr√°va rol√≠ a procent</h2>
                <p style="color: #666; margin-bottom: 20px;">Nastavte procento z v√Ωdƒõlku pro ka≈ædou roli. U≈æivatel√© budou dost√°vat toto procento z penƒõz, kter√© p≈ôinesli do skladu.</p>
                
                <!-- Formul√°≈ô pro p≈ôid√°n√≠ nov√© role -->
                <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 2px solid #2196f3;">
                    <h3 style="color: #333; margin-bottom: 15px;">‚ûï P≈ôidat novou roli</h3>
                    <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 10px; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px; margin-bottom: 5px; display: block; color: #666;">N√°zev role:</label>
                            <input type="text" id="newRoleName" placeholder="Nap≈ô. Manager, Prodejce..." 
                                   style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 12px; margin-bottom: 5px; display: block; color: #666;">Procento:</label>
                            <input type="number" id="newRolePercentage" min="0" max="100" step="0.1" value="0" 
                                   style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                        </div>
                        <button onclick="createNewRole()" class="btn-small" style="background: #2196f3; color: white; padding: 10px 20px; white-space: nowrap;">
                            P≈ôidat roli
                        </button>
                    </div>
                    <p style="color: #666; font-size: 12px; margin-top: 10px; margin-bottom: 0;">
                        N√°zev role bude pou≈æit jako kl√≠ƒç (mal√Ωmi p√≠smeny, bez mezer). Nap≈ô. "Manager" ‚Üí "manager"
                    </p>
                </div>
                
                <div id="rolesList" style="display: grid; gap: 20px; margin-bottom: 30px;">
                    <!-- Role budou naƒçteny dynamicky -->
                </div>
            </div>

            <!-- Sekce Spr√°va u≈æivatel≈Ø (pouze pro adminy) -->
            <div id="adminUsersSection" style="display: none;">
                <h2 style="color: #333; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">Spr√°va u≈æivatel≈Ø</h2>
                <div id="usersList" class="notes-list"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase konfigurace - NAHRADTE SV√ùMI HODNOTAMI Z .env SOUBORU
        const firebaseConfig = {
            apiKey: "AIzaSyBv3DNzHeqNB1JUsGWspuGz4iSjXTVurfE",
            authDomain: "poznamky-test.firebaseapp.com",
            projectId: "poznamky-test",
            storageBucket: "poznamky-test.firebasestorage.app",
            messagingSenderId: "630344048958",
            appId: "1:630344048958:web:c977457492bd8b9b8c8c6f"
        };

        // Import Firebase modul≈Ø z CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, serverTimestamp, setDoc, getDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Inicializace Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log('Firebase inicializov√°no √∫spƒõ≈°nƒõ');
            
            // Po inicializaci nastavit formul√°≈ôe
            setTimeout(() => {
                setupLoginForm();
                setupRegisterForm();
            }, 100);
        } catch (error) {
            console.error('Chyba p≈ôi inicializaci Firebase:', error);
            alert('Chyba p≈ôi inicializaci datab√°ze. Zkontrolujte konzoli pro v√≠ce informac√≠.');
        }

        // Discord webhook funkce
        // POZN√ÅMKA: Pou≈æ√≠v√°me p≈ô√≠m√© vol√°n√≠ Discord webhooku
        // Netlify Functions nejsou moment√°lnƒõ dostupn√©, tak≈æe pou≈æ√≠v√°me p≈ô√≠m√© vol√°n√≠
        const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1462804840366211250/XtoRITLxpMFbfHYlslsrMB8Rbe_JewzdU_pVjvPxVn7L3Z3LxIbZGCsLeelY9pWtYQCM';
        
        async function sendDiscordWebhook(title, description, color = '0x3498db', fields = []) {
            try {
                // P≈ô√≠m√© vol√°n√≠ Discord webhooku
                const embed = {
                    title: title,
                    description: description,
                    color: parseInt(color || '0x3498db', 16),
                    fields: fields || [],
                    timestamp: new Date().toISOString(),
                    footer: {
                        text: 'Skladov√Ω syst√©m'
                    }
                };

                const response = await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        embeds: [embed]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Unknown error');
                    console.error('Chyba p≈ôi odes√≠l√°n√≠ webhook:', response.status, response.statusText, errorText);
                } else {
                    console.log('Discord webhook √∫spƒõ≈°nƒõ odesl√°n');
                }
            } catch (error) {
                console.error('Chyba p≈ôi odes√≠l√°n√≠ Discord webhook:', error);
                // Nevyhazovat chybu - webhook nen√≠ kritick√Ω pro funkƒçnost aplikace
            }
        }

        // Odeslat notifikaci o zmƒõnƒõ skladu
        async function sendStockChangeNotification(transactionData, newStatus) {
            const itemName = getItemTypeName(transactionData.itemType);
            let title = '';
            let description = '';
            let color = '0x3498db';
            const fields = [];

            // Urƒçit typ operace
            if (transactionData.originalOperation === 'set') {
                color = '0xf39c12'; // Oran≈æov√°
                title = '‚öôÔ∏è Hodnota skladu nastavena';
                description = `${itemName} byla nastavena na ${transactionData.targetValue}`;
                const previousValue = newStatus - (transactionData.operation === 'add' ? transactionData.amount : -transactionData.amount);
                fields.push(
                    { name: 'P≈ôedchoz√≠ hodnota', value: previousValue.toString(), inline: true },
                    { name: 'Nov√° hodnota', value: newStatus.toString(), inline: true }
                );
            } else if (transactionData.operation === 'add') {
                color = '0x2ecc71'; // Zelen√°
                title = '‚ûï Polo≈æka p≈ôid√°na na sklad';
                description = `${itemName} - p≈ôid√°no ${transactionData.amount} ks`;
                fields.push(
                    { name: 'P≈ôid√°no', value: `+${transactionData.amount} ks`, inline: true },
                    { name: 'Aktu√°ln√≠ stav', value: newStatus.toString() + ' ks', inline: true }
                );
            } else if (transactionData.operation === 'remove') {
                color = '0xe74c3c'; // ƒåerven√°
                title = '‚ûñ Polo≈æka odebr√°na ze skladu';
                description = `${itemName} - odebr√°no ${transactionData.amount} ks`;
                fields.push(
                    { name: 'Odebr√°no', value: `-${transactionData.amount} ks`, inline: true },
                    { name: 'Aktu√°ln√≠ stav', value: newStatus.toString() + ' ks', inline: true }
                );
            }

            // P≈ôidat dal≈°√≠ informace
            fields.push({ name: 'Polo≈æka', value: itemName, inline: true });
            if (transactionData.note) {
                fields.push({ name: 'Pozn√°mka', value: transactionData.note, inline: false });
            }
            fields.push({ name: 'Zmƒõnu provedl', value: transactionData.userEmail || 'Nezn√°m√Ω u≈æivatel', inline: false });

            await sendDiscordWebhook(title, description, color, fields);
        }

        // Odeslat p≈ôehled stavu skladu
        async function sendStockOverview(money, tickets, bags) {
            const fields = [
                { name: 'üí∞ Pen√≠ze', value: money.toString(), inline: true },
                { name: 'üé´ Koka-listky', value: tickets.toString(), inline: true },
                { name: 'üì¶ S√°ƒçky', value: bags.toString(), inline: true }
            ];

            await sendDiscordWebhook(
                'üìä P≈ôehled stavu skladu',
                'Aktu√°ln√≠ p≈ôehled v≈°ech polo≈æek na skladƒõ',
                '0x3498db',
                fields
            );
        }

        // Odeslat notifikaci o v√Ωplatƒõ
        async function sendSalaryPaymentNotification(userEmail, userRole, salary, totalEarned, rolePercentage, paidBy) {
            const roleNames = {
                user: 'U≈æivatel',
                moderator: 'Moder√°tor',
                admin: 'Administr√°tor'
            };
            
            const roleName = roleNames[userRole] || userRole;
            
            const fields = [
                { name: 'üë§ U≈æivatel', value: userEmail, inline: true },
                { name: 'üé≠ Role', value: roleName, inline: true },
                { name: 'üí∞ V√Ωplata', value: `${salary.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Kƒç`, inline: false },
                { name: 'üìä Podrobnosti', value: `P≈ôineseno: ${totalEarned.toLocaleString('cs-CZ')} Kƒç\nProcento: ${rolePercentage}%\nV√Ωpoƒçet: ${totalEarned.toLocaleString('cs-CZ')} Kƒç √ó ${rolePercentage}% = ${salary.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Kƒç`, inline: false },
                { name: '‚úÖ Vyplatil', value: paidBy || 'Nezn√°m√Ω', inline: false }
            ];

            await sendDiscordWebhook(
                'üíµ V√Ωplata byla vyplacena',
                `U≈æivateli ${userEmail} byla vyplacena v√Ωplata ve v√Ω≈°i ${salary.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Kƒç`,
                '0x4caf50', // Zelen√° barva
                fields
            );
        }

        // State management
        let currentUser = null;
        let currentUserRole = 'user'; // user, moderator, admin
        let notesUnsubscribe = null;
        let allNotesUnsubscribe = null;
        let usersUnsubscribe = null;
        let myTransactionsUnsubscribe = null;
        let adminFilterUser = '';
        let currentStockStatus = { money: 0, tickets: 0, bags: 0 }; // Aktu√°ln√≠ stav skladu
        let adminFilterType = '';
        let adminFilterDate = '';
        let adminFilterDateFrom = '';
        let adminFilterDateTo = '';
        let adminSearch = '';
        let userFilterType = '';
        let userFilterDate = '';
        let userFilterDateFrom = '';
        let userFilterDateTo = '';
        let userSearch = '';
        let currentPage = 1;
        let currentUserPage = 1;
        const itemsPerPage = 20;

        // Helper funkce
        function showScreen(screenId) {
            document.querySelectorAll('[id$="Screen"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        function hideError(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Nezn√°m√© datum';
            const date = timestamp.toDate();
            return date.toLocaleString('cs-CZ', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Login - ƒçek√°me na inicializaci Firebase
        function setupLoginForm() {
            const loginForm = document.getElementById('loginForm');
            if (!loginForm) {
                console.error('Login formul√°≈ô nebyl nalezen, zkou≈°√≠m znovu...');
                setTimeout(setupLoginForm, 100);
                return;
            }
            
            console.log('Login formul√°≈ô nalezen, p≈ôid√°v√°m event listener');
            
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Login formul√°≈ô odesl√°n');
                
                hideError('loginError');
                
                if (!auth) {
                    const errorMsg = 'Datab√°ze nen√≠ inicializov√°na. Obnovte str√°nku.';
                    showError('loginError', errorMsg);
                    console.error('Auth nen√≠ inicializov√°no');
                    alert(errorMsg);
                    return;
                }
                
                const loginInput = document.getElementById('loginEmail').value.trim();
                if (!loginInput) {
                    showError('loginError', 'Zadejte p≈ôezd√≠vku nebo email');
                    return;
                }
                // Pokud obsahuje @, pou≈æ√≠t p≈ô√≠mo jako email (pro star√© √∫ƒçty)
                // Pokud neobsahuje @, p≈ôidat @local.local (pro nov√© p≈ôezd√≠vky)
                const email = loginInput.includes('@') ? loginInput : `${loginInput}@local.local`;
                const password = document.getElementById('loginPassword').value;

                if (!password) {
                    showError('loginError', 'Zadejte heslo');
                    return;
                }

                try {
                    console.log('Pokus o p≈ôihl√°≈°en√≠:', email);
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    console.log('P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©:', userCredential.user.email);
                } catch (error) {
                    console.error('Chyba p≈ôi p≈ôihla≈°ov√°n√≠:', error);
                    let errorMessage = 'Chyba p≈ôi p≈ôihla≈°ov√°n√≠: ';
                    
                    // P≈ôelo≈æit chybov√© hl√°≈°ky do ƒçe≈°tiny
                    switch(error.code) {
                        case 'auth/user-not-found':
                            errorMessage = 'U≈æivatel s t√≠mto emailem neexistuje';
                            break;
                        case 'auth/wrong-password':
                            errorMessage = 'Nespr√°vn√© heslo';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Neplatn√Ω email';
                            break;
                        case 'auth/user-disabled':
                            errorMessage = 'Tento √∫ƒçet byl deaktivov√°n';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'P≈ô√≠li≈° mnoho pokus≈Ø. Zkuste to pozdƒõji';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'Chyba p≈ôipojen√≠ k s√≠ti. Zkontrolujte internet';
                            break;
                        default:
                            errorMessage += error.message || error.code || 'Nezn√°m√° chyba';
                    }
                    
                    showError('loginError', errorMessage);
                }
            });
        }

        // Register - ƒçek√°me na inicializaci Firebase
        function setupRegisterForm() {
            const registerForm = document.getElementById('registerForm');
            if (!registerForm) {
                console.error('Register formul√°≈ô nebyl nalezen, zkou≈°√≠m znovu...');
                setTimeout(setupRegisterForm, 100);
                return;
            }
            
            console.log('Register formul√°≈ô nalezen, p≈ôid√°v√°m event listener');
            
            registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError('registerError');

            const registerInput = document.getElementById('registerEmail').value.trim();
            if (!registerInput) {
                showError('registerError', 'Zadejte p≈ôezd√≠vku');
                return;
            }
            
            // Pokud u≈æivatel zad√° email (obsahuje @), pou≈æ√≠t ho p≈ô√≠mo
            // Pokud zad√° p≈ôezd√≠vku (neobsahuje @), p≈ôidat @local.local
            let email, nickname;
            if (registerInput.includes('@')) {
                // U≈æivatel zadal email - pou≈æ√≠t ho p≈ô√≠mo
                email = registerInput;
                // Z emailu vytvo≈ôit p≈ôezd√≠vku (ƒç√°st p≈ôed @)
                nickname = registerInput.split('@')[0];
            } else {
                // U≈æivatel zadal p≈ôezd√≠vku - p≈ôidat @local.local
                nickname = registerInput;
                email = `${registerInput}@local.local`;
            }
            
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            if (password !== passwordConfirm) {
                showError('registerError', 'Hesla se neshoduj√≠');
                return;
            }

            if (password.length < 6) {
                showError('registerError', 'Heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Vytvo≈ôit z√°znam u≈æivatele BEZ role - role bude p≈ôi≈ôazena pozdƒõji adminem/moder√°torem
                // Ulo≈æit p≈ôezd√≠vku (bez @local.local) jako email pro zobrazen√≠
                await setDoc(doc(db, 'users', user.uid), {
                    email: nickname, // Ulo≈æit p≈ôezd√≠vku jako email pro zobrazen√≠
                    originalEmail: email, // Ulo≈æit p≈Øvodn√≠ email pro Firebase Auth
                    // role nen√≠ nastavena - u≈æivatel ƒçek√° na p≈ôi≈ôazen√≠
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
            } catch (error) {
                showError('registerError', 'Chyba p≈ôi registraci: ' + error.message);
            }
            });
        }

        // Navigation
        document.getElementById('showRegister').addEventListener('click', (e) => {
            e.preventDefault();
            showScreen('registerScreen');
        });

        document.getElementById('showLogin').addEventListener('click', (e) => {
            e.preventDefault();
            showScreen('loginScreen');
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await signOut(auth);
        });

        document.getElementById('adminLogoutBtn').addEventListener('click', async () => {
            await signOut(auth);
        });

        document.getElementById('waitingLogoutBtn').addEventListener('click', async () => {
            await signOut(auth);
        });

        document.getElementById('myTransactionsLogoutBtn').addEventListener('click', async () => {
            await signOut(auth);
        });

        // Navigation - Moje transakce
        document.getElementById('myTransactionsBtn').addEventListener('click', () => {
            showScreen('myTransactionsScreen');
            const q = query(collection(db, 'stockTransactions'));
            getDocs(q).then(snapshot => {
                const transactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                loadMyTransactions(transactions);
            });
        });

        document.getElementById('backToSkladBtn').addEventListener('click', () => {
            showScreen('notesScreen');
            loadStockStatus();
        });

        // Zmƒõna hesla
        document.getElementById('changePasswordBtn').addEventListener('click', () => {
            showScreen('changePasswordScreen');
            document.getElementById('changePasswordForm').reset();
            hideError('changePasswordError');
            const successMsg = document.getElementById('changePasswordSuccess');
            if (successMsg) successMsg.classList.add('hidden');
        });

        document.getElementById('backToSkladFromPasswordBtn').addEventListener('click', () => {
            showScreen('notesScreen');
            loadStockStatus();
        });

        // Tlaƒç√≠tko pro odesl√°n√≠ p≈ôehledu skladu na Discord
        document.getElementById('sendDiscordOverviewBtn').addEventListener('click', async () => {
            try {
                await sendStockOverview(
                    currentStockStatus.money,
                    currentStockStatus.tickets,
                    currentStockStatus.bags
                );
                alert('P≈ôehled skladu byl odesl√°n na Discord!');
            } catch (error) {
                console.error('Chyba p≈ôi odes√≠l√°n√≠ p≈ôehledu:', error);
                alert('Nepoda≈ôilo se odeslat p≈ôehled na Discord');
            }
        });

        // Formul√°≈ô pro zmƒõnu hesla
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError('changePasswordError');
            const successMsg = document.getElementById('changePasswordSuccess');
            if (successMsg) successMsg.classList.add('hidden');

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const newPasswordConfirm = document.getElementById('newPasswordConfirm').value;

            if (!currentPassword || !newPassword || !newPasswordConfirm) {
                showError('changePasswordError', 'Vypl≈àte v≈°echna pole');
                return;
            }

            if (newPassword !== newPasswordConfirm) {
                showError('changePasswordError', 'Nov√° hesla se neshoduj√≠');
                return;
            }

            if (newPassword.length < 6) {
                showError('changePasswordError', 'Nov√© heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø');
                return;
            }

            if (currentPassword === newPassword) {
                showError('changePasswordError', 'Nov√© heslo mus√≠ b√Ωt jin√© ne≈æ souƒçasn√©');
                return;
            }

            try {
                if (!currentUser || !auth.currentUser) {
                    showError('changePasswordError', 'Nejste p≈ôihl√°≈°eni');
                    return;
                }

                // Re-autentizace u≈æivatele se souƒçasn√Ωm heslem
                // Pro re-autentizaci mus√≠me pou≈æ√≠t p≈Øvodn√≠ email z Firebase Auth
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const originalEmail = userDoc.exists() && userDoc.data().originalEmail ? userDoc.data().originalEmail : currentUser.email;
                const credential = EmailAuthProvider.credential(
                    originalEmail,
                    currentPassword
                );
                
                await reauthenticateWithCredential(auth.currentUser, credential);
                
                // Zmƒõna hesla
                await updatePassword(auth.currentUser, newPassword);
                
                // Zobrazit √∫spƒõ≈°nou zpr√°vu
                if (successMsg) {
                    successMsg.textContent = 'Heslo bylo √∫spƒõ≈°nƒõ zmƒõnƒõno!';
                    successMsg.classList.remove('hidden');
                }
                
                // Vyƒçistit formul√°≈ô
                document.getElementById('changePasswordForm').reset();
                
                // Po 2 sekund√°ch vr√°tit na sklad
                setTimeout(() => {
                    showScreen('notesScreen');
                    if (successMsg) successMsg.classList.add('hidden');
                }, 2000);
                
            } catch (error) {
                console.error('Chyba p≈ôi zmƒõnƒõ hesla:', error);
                let errorMessage = 'Chyba p≈ôi zmƒõnƒõ hesla: ';
                
                switch(error.code) {
                    case 'auth/wrong-password':
                        errorMessage = 'Souƒçasn√© heslo nen√≠ spr√°vn√©';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Nov√© heslo je p≈ô√≠li≈° slab√©';
                        break;
                    case 'auth/requires-recent-login':
                        errorMessage = 'Pro zmƒõnu hesla se mus√≠te znovu p≈ôihl√°sit';
                        break;
                    default:
                        errorMessage += error.message || error.code || 'Nezn√°m√° chyba';
                }
                
                showError('changePasswordError', errorMessage);
            }
        });

        // Stock form - p≈ôid√°n√≠ transakce
        document.getElementById('stockForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const itemType = document.getElementById('stockItemType').value;
            const operation = document.getElementById('stockOperation').value;
            let amount = parseInt(document.getElementById('stockAmount').value);
            const note = document.getElementById('stockNote').value.trim();

            if (!itemType || !operation || amount === null || amount < 0) {
                alert('Vypl≈àte v≈°echna pole spr√°vnƒõ');
                return;
            }

            // Pro operace add/remove mus√≠ b√Ωt amount > 0
            if ((operation === 'add' || operation === 'remove') && amount <= 0) {
                alert('Poƒçet mus√≠ b√Ωt vƒõt≈°√≠ ne≈æ 0');
                return;
            }

            try {
                // D≈ÆLE≈ΩIT√â: V≈ædy zkontrolovat aktu√°ln√≠ stav z datab√°ze p≈ôed ulo≈æen√≠m
                const currentStatus = await getCurrentStockStatus(itemType);
                
                // Validace pro operaci "remove" - mus√≠ b√Ωt dostateƒçn√© mno≈æstv√≠
                if (operation === 'remove') {
                    if (currentStatus < amount) {
                        const itemName = getItemTypeName(itemType);
                        alert(`Na skladƒõ nen√≠ dostatek ${itemName.toLowerCase()}! Aktu√°lnƒõ je k dispozici pouze ${currentStatus}, ale chcete vz√≠t ${amount}.`);
                        return;
                    }
                }

                // Z√≠skat p≈ôezd√≠vku u≈æivatele z datab√°ze
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const userDisplayName = userDoc.exists() && userDoc.data().email ? userDoc.data().email : currentUser.email;
                
                let transactionData = {
                    itemType: itemType,
                    operation: operation,
                    amount: amount,
                    userId: currentUser.uid,
                    userEmail: userDisplayName,
                    note: note || '', // Pozn√°mka k transakci
                    createdAt: serverTimestamp(),
                    // Ulo≈æit aktu√°ln√≠ stav v dobƒõ transakce (pro audit)
                    stockStatusAtTime: currentStatus
                };

                // Pokud je operace "set", mus√≠me vypoƒç√≠tat rozd√≠l od aktu√°ln√≠ho stavu
                if (operation === 'set') {
                    const difference = amount - currentStatus;
                    
                    if (difference === 0) {
                        alert(`Hodnota ${getItemTypeName(itemType)} je ji≈æ nastavena na ${amount}`);
                        // Vyƒçistit formul√°≈ô
                        document.getElementById('stockItemType').value = '';
                        document.getElementById('stockOperation').value = '';
                        document.getElementById('stockAmount').value = '';
                        return;
                    }

                    // Validace: pokud chceme nastavit na hodnotu ni≈æ≈°√≠ ne≈æ aktu√°ln√≠, 
                    // mus√≠me zkontrolovat, zda m√°me dostatek k odebr√°n√≠
                    if (difference < 0 && currentStatus < Math.abs(difference)) {
                        alert(`Nelze nastavit hodnotu na ${amount}, proto≈æe aktu√°lnƒõ je na skladƒõ pouze ${currentStatus}`);
                        return;
                    }

                    // Ulo≈æit jako add nebo remove podle rozd√≠lu
                    transactionData.operation = difference > 0 ? 'add' : 'remove';
                    transactionData.amount = Math.abs(difference);
                    transactionData.originalOperation = 'set'; // Oznaƒçit ≈æe to bylo nastaven√≠
                    transactionData.targetValue = amount; // Ulo≈æit c√≠lovou hodnotu
                }

                // Ulo≈æit transakci do datab√°ze
                await addDoc(collection(db, 'stockTransactions'), transactionData);

                // Vypoƒç√≠tat nov√Ω stav po transakci
                const newStatus = transactionData.operation === 'add' 
                    ? currentStatus + transactionData.amount 
                    : currentStatus - transactionData.amount;

                // Odeslat notifikaci na Discord
                try {
                    await sendStockChangeNotification(transactionData, newStatus);
                } catch (error) {
                    console.error('Chyba p≈ôi odes√≠l√°n√≠ Discord notifikace:', error);
                    // Pokraƒçovat i kdy≈æ webhook sel≈æe
                }

                // Vyƒçistit formul√°≈ô
                document.getElementById('stockItemType').value = '';
                document.getElementById('stockOperation').value = '';
                document.getElementById('stockAmount').value = '';
                document.getElementById('stockNote').value = '';
                
                if (operation === 'set') {
                    alert(`Hodnota ${getItemTypeName(itemType)} byla nastavena na ${transactionData.targetValue}`);
                }
            } catch (error) {
                console.error('Chyba p≈ôi ukl√°d√°n√≠ transakce:', error);
                alert('Nepoda≈ôilo se ulo≈æit transakci: ' + error.message);
            }
        });

        // Pomocn√° funkce pro z√≠sk√°n√≠ aktu√°ln√≠ho stavu konkr√©tn√≠ho typu polo≈æky
        async function getCurrentStockStatus(itemType) {
            try {
                const q = query(collection(db, 'stockTransactions'));
                const snapshot = await getDocs(q);
                const transactions = snapshot.docs.map(doc => doc.data());
                
                let current = 0;
                transactions.forEach(transaction => {
                    if (transaction.itemType === itemType) {
                        const change = transaction.operation === 'add' ? transaction.amount : -transaction.amount;
                        current += change;
                    }
                });
                
                return current;
            } catch (error) {
                console.error('Chyba p≈ôi z√≠sk√°v√°n√≠ aktu√°ln√≠ho stavu:', error);
                return 0;
            }
        }

        // Pomocn√° funkce pro z√≠sk√°n√≠ n√°zvu typu polo≈æky
        function getItemTypeName(itemType) {
            const names = {
                'money': 'Pen√≠ze',
                'tickets': 'Koka-listky',
                'bags': 'S√°ƒçky'
            };
            return names[itemType] || itemType;
        }

        // Aktualizace formul√°≈ôe podle role u≈æivatele
        function updateStockFormForRole(role) {
            const adminSetOption = document.getElementById('adminSetOption');
            const adminSetLabel = document.getElementById('adminSetLabel');
            const stockOperation = document.getElementById('stockOperation');
            const stockAmountLabel = document.getElementById('stockAmountLabel');
            const stockAmount = document.getElementById('stockAmount');
            
            if (role === 'admin') {
                if (adminSetOption) adminSetOption.classList.remove('hidden');
                if (adminSetLabel) adminSetLabel.classList.remove('hidden');
            } else {
                if (adminSetOption) adminSetOption.classList.add('hidden');
                if (adminSetLabel) adminSetLabel.classList.add('hidden');
                // Pokud je vybran√° operace "set" a u≈æivatel nen√≠ admin, resetovat
                if (stockOperation && stockOperation.value === 'set') {
                    stockOperation.value = '';
                }
            }

            // Nastavit listener na zmƒõnu operace (pokud je≈°tƒõ nen√≠ nastaven)
            if (stockOperation && stockAmountLabel && !stockOperation.hasAttribute('data-listener-set')) {
                stockOperation.setAttribute('data-listener-set', 'true');
                stockOperation.addEventListener('change', (e) => {
                    if (e.target.value === 'set') {
                        stockAmountLabel.textContent = 'Hodnota (nastavit na):';
                        if (stockAmount) stockAmount.min = '0';
                    } else {
                        stockAmountLabel.textContent = 'Poƒçet:';
                        if (stockAmount) stockAmount.min = '1';
                    }
                });
            }
        }

        // Load stock status - v√Ωpoƒçet aktu√°ln√≠ho stavu z transakc√≠
        function loadStockStatus() {
            if (notesUnsubscribe) notesUnsubscribe();

            const q = query(collection(db, 'stockTransactions'));
            notesUnsubscribe = onSnapshot(q, (snapshot) => {
                const transactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Vypoƒç√≠tat aktu√°ln√≠ stav pro ka≈æd√Ω typ polo≈æky
                let money = 0;
                let tickets = 0;
                let bags = 0;

                transactions.forEach(transaction => {
                    const change = transaction.operation === 'add' ? transaction.amount : -transaction.amount;
                    
                    switch(transaction.itemType) {
                        case 'money':
                            money += change;
                            break;
                        case 'tickets':
                            tickets += change;
                            break;
                        case 'bags':
                            bags += change;
                            break;
                    }
                });

                // Ulo≈æit aktu√°ln√≠ stav do glob√°ln√≠ promƒõnn√©
                currentStockStatus = { money, tickets, bags };

                // Zobrazit aktu√°ln√≠ stav
                document.getElementById('stockMoney').textContent = money;
                document.getElementById('stockTickets').textContent = tickets;
                document.getElementById('stockBags').textContent = bags;
                
                // Naƒç√≠st u≈æivatelovy transakce (pouze pokud je u≈æivatel p≈ôihl√°≈°en)
                if (currentUser) {
                    loadMyTransactions(transactions);
                }
            });
        }

        // Naƒçten√≠ u≈æivatelov√Ωch transakc√≠
        function loadMyTransactions(allTransactions) {
            if (!currentUser) return;
            
            // Filtrovat pouze transakce aktu√°ln√≠ho u≈æivatele
            let myTransactions = allTransactions
                .filter(t => t.userId === currentUser.uid)
                .sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

            // Aplikovat filtry
            if (userFilterType) {
                myTransactions = myTransactions.filter(t => t.itemType === userFilterType);
            }
            
            if (userFilterDate) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                myTransactions = myTransactions.filter(t => {
                    if (!t.createdAt) return false;
                    const transDate = t.createdAt.toDate();
                    
                    if (userFilterDate === 'today') {
                        return transDate >= today;
                    } else if (userFilterDate === 'week') {
                        const weekAgo = new Date(today);
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return transDate >= weekAgo;
                    } else if (userFilterDate === 'month') {
                        const monthAgo = new Date(today);
                        monthAgo.setMonth(monthAgo.getMonth() - 1);
                        return transDate >= monthAgo;
                    } else if (userFilterDate === 'custom' && userFilterDateFrom && userFilterDateTo) {
                        const fromDate = new Date(userFilterDateFrom);
                        const toDate = new Date(userFilterDateTo);
                        toDate.setHours(23, 59, 59, 999);
                        return transDate >= fromDate && transDate <= toDate;
                    }
                    return true;
                });
            }
            
            if (userSearch) {
                const searchLower = userSearch.toLowerCase();
                myTransactions = myTransactions.filter(t => {
                    const note = (t.note || '').toLowerCase();
                    return note.includes(searchLower);
                });
            }

            // Paginace
            const totalPages = Math.ceil(myTransactions.length / itemsPerPage);
            const startIndex = (currentUserPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTransactions = myTransactions.slice(startIndex, endIndex);

            const transactionsList = document.getElementById('myTransactionsList');
            if (myTransactions.length === 0) {
                transactionsList.innerHTML = '<div class="empty-state"><p>Zat√≠m jste neprovedli ≈æ√°dn√© transakce nebo ≈æ√°dn√© neodpov√≠daj√≠ filtr≈Øm.</p></div>';
                document.getElementById('myTransactionsPagination').innerHTML = '';
            } else {
                transactionsList.innerHTML = paginatedTransactions.map(transaction => {
                    const itemTypeNames = {
                        'money': 'Pen√≠ze',
                        'tickets': 'Koka-listky',
                        'bags': 'S√°ƒçky'
                    };
                    const operationNames = {
                        'add': 'Ulo≈æil',
                        'remove': 'Vzal',
                        'set': 'Nastavil'
                    };
                    const operationColors = {
                        'add': '#4caf50',
                        'remove': '#f44336',
                        'set': '#ff9800'
                    };
                    
                    let operationText = operationNames[transaction.operation] || transaction.operation;
                    let amountText = transaction.amount;
                    
                    if (transaction.originalOperation === 'set' && transaction.targetValue !== undefined) {
                        operationText = 'Nastavil na';
                        amountText = transaction.targetValue;
                    }
                    
                    return `
                        <div class="note-card">
                            <div class="note-content">
                                <p class="note-text">
                                    <span style="color: ${operationColors[transaction.operation] || '#333'}; font-weight: bold;">
                                        ${operationText}
                                    </span>
                                    <strong>${amountText}</strong> x ${itemTypeNames[transaction.itemType] || transaction.itemType}
                                </p>
                                ${transaction.note ? `<p style="color: #666; font-style: italic; margin-top: 5px; font-size: 14px;">üí¨ ${transaction.note}</p>` : ''}
                                <p class="note-date">${formatDate(transaction.createdAt)}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // P≈ôidat paginaci
                const paginationDiv = document.getElementById('myTransactionsPagination');
                if (totalPages > 1) {
                    paginationDiv.innerHTML = `
                        <button onclick="changeUserPage(${currentUserPage - 1})" ${currentUserPage === 1 ? 'disabled style="opacity: 0.5;"' : 'class="btn-small"'} style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">‚Üê P≈ôedchoz√≠</button>
                        <span style="padding: 8px 15px;">Str√°nka ${currentUserPage} z ${totalPages} (celkem ${myTransactions.length} transakc√≠)</span>
                        <button onclick="changeUserPage(${currentUserPage + 1})" ${currentUserPage === totalPages ? 'disabled style="opacity: 0.5;"' : 'class="btn-small"'} style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">Dal≈°√≠ ‚Üí</button>
                    `;
                } else {
                    paginationDiv.innerHTML = `<span style="color: #666;">Zobrazeno ${myTransactions.length} transakc√≠</span>`;
                }
            }
        }

        // Load admin transactions history
        function loadAdminNotes() {
            if (allNotesUnsubscribe) allNotesUnsubscribe();

            const q = query(collection(db, 'stockTransactions'));
            allNotesUnsubscribe = onSnapshot(q, (snapshot) => {
                const transactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })).sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                // Poƒç√≠tat statistiky
                const uniqueUsers = [...new Set(transactions.map(t => t.userEmail))];
                const totalTransactions = transactions.length;

                document.getElementById('totalNotes').textContent = totalTransactions;
                document.getElementById('totalUsers').textContent = uniqueUsers.length;

                // Naplnit dropdown s u≈æivateli pro filtr
                const userFilterSelect = document.getElementById('adminFilterUser');
                if (userFilterSelect) {
                    const currentValue = userFilterSelect.value;
                    userFilterSelect.innerHTML = '<option value="">V≈°ichni u≈æivatel√©</option>' + 
                        uniqueUsers.map(email => `<option value="${email}">${email}</option>`).join('');
                    if (currentValue) {
                        userFilterSelect.value = currentValue;
                    }
                }

                // Aplikovat filtry
                let filteredTransactions = transactions;
                
                // Filtr podle u≈æivatele
                if (adminFilterUser) {
                    filteredTransactions = filteredTransactions.filter(t => t.userEmail === adminFilterUser);
                }
                
                // Filtr podle typu
                if (adminFilterType) {
                    filteredTransactions = filteredTransactions.filter(t => t.itemType === adminFilterType);
                }
                
                // Filtr podle data
                if (adminFilterDate) {
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    
                    filteredTransactions = filteredTransactions.filter(t => {
                        if (!t.createdAt) return false;
                        const transDate = t.createdAt.toDate();
                        
                        if (adminFilterDate === 'today') {
                            return transDate >= today;
                        } else if (adminFilterDate === 'week') {
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            return transDate >= weekAgo;
                        } else if (adminFilterDate === 'month') {
                            const monthAgo = new Date(today);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            return transDate >= monthAgo;
                        } else if (adminFilterDate === 'custom' && adminFilterDateFrom && adminFilterDateTo) {
                            const fromDate = new Date(adminFilterDateFrom);
                            const toDate = new Date(adminFilterDateTo);
                            toDate.setHours(23, 59, 59, 999);
                            return transDate >= fromDate && transDate <= toDate;
                        }
                        return true;
                    });
                }
                
                // Vyhled√°v√°n√≠ v pozn√°mk√°ch
                if (adminSearch) {
                    const searchLower = adminSearch.toLowerCase();
                    filteredTransactions = filteredTransactions.filter(t => {
                        const note = (t.note || '').toLowerCase();
                        const userEmail = (t.userEmail || '').toLowerCase();
                        return note.includes(searchLower) || userEmail.includes(searchLower);
                    });
                }

                // Paginace
                const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedTransactions = filteredTransactions.slice(startIndex, endIndex);

                const notesList = document.getElementById('adminNotesList');
                if (filteredTransactions.length === 0) {
                    notesList.innerHTML = '<div class="empty-state"><p>≈Ω√°dn√© transakce neodpov√≠daj√≠ zvolen√Ωm filtr≈Øm.</p></div>';
                    document.getElementById('adminNotesPagination').innerHTML = '';
                } else {
                    notesList.innerHTML = paginatedTransactions.map(transaction => {
                        const itemTypeNames = {
                            'money': 'Pen√≠ze',
                            'tickets': 'Koka-listky',
                            'bags': 'S√°ƒçky'
                        };
                        const operationNames = {
                            'add': 'Ulo≈æil',
                            'remove': 'Vzal',
                            'set': 'Nastavil na'
                        };
                        const operationColors = {
                            'add': '#4caf50',
                            'remove': '#f44336',
                            'set': '#ff9800'
                        };
                        
                        // Pokud je to nastaven√≠, zobrazit c√≠lovou hodnotu
                        let operationText = operationNames[transaction.operation] || transaction.operation;
                        let amountText = transaction.amount;
                        
                        if (transaction.originalOperation === 'set' && transaction.targetValue !== undefined) {
                            operationText = 'Nastavil na';
                            amountText = transaction.targetValue;
                        }
                        
                        return `
                            <div class="note-card" id="transaction_${transaction.id}">
                                <div class="note-content" style="flex: 1;">
                                    <p style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; display: inline-block; margin-bottom: 10px;">${transaction.userEmail}</p>
                                    <p class="note-text">
                                        <span style="color: ${operationColors[transaction.operation] || '#333'}; font-weight: bold;">
                                            ${operationText}
                                        </span>
                                        <strong>${amountText}</strong> x ${itemTypeNames[transaction.itemType] || transaction.itemType}
                                        ${transaction.originalOperation === 'set' && transaction.targetValue !== transaction.amount ? ` (rozd√≠l: ${transaction.amount > 0 ? '+' : ''}${transaction.operation === 'add' ? transaction.amount : -transaction.amount})` : ''}
                                    </p>
                                    ${transaction.note ? `<p style="color: #666; font-style: italic; margin-top: 5px; font-size: 14px;">üí¨ ${transaction.note}</p>` : ''}
                                    <p class="note-date">${formatDate(transaction.createdAt)}</p>
                                </div>
                                ${currentUserRole === 'admin' ? `
                                    <div style="display: flex; gap: 5px; flex-direction: column;">
                                        <button class="btn-small" style="background: #2196f3; color: white; font-size: 11px; padding: 4px 8px;" onclick="editTransaction('${transaction.id}')" title="Upravit">‚úèÔ∏è</button>
                                        <button class="btn-small" style="background: #f44336; color: white; font-size: 11px; padding: 4px 8px;" onclick="deleteTransaction('${transaction.id}')" title="Smazat">üóëÔ∏è</button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                    
                    // P≈ôidat paginaci
                    const paginationDiv = document.getElementById('adminNotesPagination') || document.createElement('div');
                    paginationDiv.id = 'adminNotesPagination';
                    paginationDiv.style.cssText = 'display: flex; justify-content: center; gap: 10px; margin-top: 20px; align-items: center;';
                    
                    if (totalPages > 1) {
                        paginationDiv.innerHTML = `
                            <button onclick="changeAdminPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled style="opacity: 0.5;"' : 'class="btn-small"'} style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">‚Üê P≈ôedchoz√≠</button>
                            <span style="padding: 8px 15px;">Str√°nka ${currentPage} z ${totalPages} (celkem ${filteredTransactions.length} transakc√≠)</span>
                            <button onclick="changeAdminPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled style="opacity: 0.5;"' : 'class="btn-small"'} style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">Dal≈°√≠ ‚Üí</button>
                        `;
                    } else {
                        paginationDiv.innerHTML = `<span style="color: #666;">Zobrazeno ${filteredTransactions.length} transakc√≠</span>`;
                    }
                    
                    if (!document.getElementById('adminNotesPagination')) {
                        notesList.parentNode.appendChild(paginationDiv);
                    }
                }
            });
        }

        // Admin navigation
        document.getElementById('adminBtn').addEventListener('click', () => {
            showScreen('adminScreen');
            showAdminTab('notes');
            loadAdminNotes();
        });

        document.getElementById('backToNotesBtn').addEventListener('click', () => {
            showScreen('notesScreen');
            loadStockStatus();
        });

        // Make functions global (deleteNote removed - no longer needed)

        // Funkce pro z√≠sk√°n√≠ role u≈æivatele
        async function getUserRole(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    const role = userDoc.data().role;
                    // Pokud m√° roli, vr√°tit ji
                    if (role) {
                        return role;
                    }
                    // Pokud nem√° roli, vr√°tit null (u≈æivatel ƒçek√° na p≈ôi≈ôazen√≠)
                    return null;
                }
                // Pokud u≈æivatel nem√° z√°znam v datab√°zi
                // Pro admin@admin.com automaticky nastavit admin roli
                if (currentUser && currentUser.email === 'admin@admin.com') {
                    await setDoc(doc(db, 'users', userId), {
                        email: currentUser.email,
                        role: 'admin',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    return 'admin';
                }
                // Pro ostatn√≠ u≈æivatele bez z√°znamu - vr√°tit null (ƒçekaj√≠ na p≈ôi≈ôazen√≠ role)
                return null;
            } catch (error) {
                console.error('Chyba p≈ôi z√≠sk√°v√°n√≠ role:', error);
                return null; // V p≈ô√≠padƒõ chyby tak√© vr√°tit null
            }
        }

        // Funkce pro zmƒõnu role u≈æivatele
        async function changeUserRole(userId, userEmail, newRole, selectElement) {
            // Z√≠skat aktu√°ln√≠ roli z select elementu (pr√°zdn√Ω string se p≈ôevede na null)
            const currentRoleValue = selectElement.dataset.currentRole || '';
            const currentRole = currentRoleValue === '' ? null : currentRoleValue;
            const newRoleValue = newRole || null; // Pr√°zdn√Ω string = null (bez role)
            
            // Pokud se role nezmƒõnila, nic nedƒõlat
            if (currentRole === newRoleValue) {
                // Vr√°tit dropdown na p≈Øvodn√≠ hodnotu
                selectElement.value = currentRole || '';
                return;
            }

            // Potvrdit zmƒõnu
            const currentRoleDisplay = currentRole || '(bez role)';
            const newRoleDisplay = newRoleValue || '(bez role)';
            const confirmMessage = `Opravdu chcete zmƒõnit roli u≈æivatele ${userEmail} z "${currentRoleDisplay}" na "${newRoleDisplay}"?`;
            
            if (!confirm(confirmMessage)) {
                // Vr√°tit dropdown na p≈Øvodn√≠ hodnotu
                selectElement.value = currentRole || '';
                return;
            }

            try {
                // Ulo≈æit do datab√°ze
                if (newRoleValue) {
                    // Pokud je nov√° role nastavena, ulo≈æit ji
                    await setDoc(doc(db, 'users', userId), {
                        email: userEmail,
                        role: newRoleValue,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                } else {
                    // Pokud je pr√°zdn√° (bez role), odstranit roli z dokumentu
                    await setDoc(doc(db, 'users', userId), {
                        email: userEmail,
                        role: null,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                }
                
                // Aktualizovat dataset, aby reflektoval novou roli
                selectElement.dataset.currentRole = newRoleValue || '';
                
                // Zobrazit √∫spƒõ≈°nou zpr√°vu (ale ne reloadovat cel√Ω seznam)
                const badge = selectElement.closest('.user-card').querySelector('.role-badge');
                if (badge) {
                    if (newRoleValue) {
                        badge.textContent = newRoleValue;
                        badge.className = 'role-badge role-' + newRoleValue;
                        badge.style.background = '';
                        badge.style.color = '';
                    } else {
                        badge.textContent = '(bez role)';
                        badge.className = 'role-badge role-none';
                        badge.style.background = '#999';
                        badge.style.color = 'white';
                    }
                }
                
                // Pokud u≈æivatel nemƒõl roli a teƒè ji dostal, zobrazit √∫spƒõ≈°nou zpr√°vu
                if (!currentRole && newRoleValue) {
                    alert(`Role "${newRoleValue}" byla √∫spƒõ≈°nƒõ p≈ôi≈ôazena u≈æivateli ${userEmail}. U≈æivatel nyn√≠ m√° p≈ô√≠stup k aplikaci.`);
                }
                
                // Aktualizovat pouze badge a dropdown, ne naƒç√≠tat cel√Ω seznam (aby to neprob√≠halo)
                // await loadUsers(); // Odstranƒõno - zp≈Øsobovalo problik√°v√°n√≠
                
            } catch (error) {
                console.error('Chyba p≈ôi zmƒõnƒõ role:', error);
                alert('Nepoda≈ôilo se zmƒõnit roli: ' + error.message);
                // Vr√°tit dropdown na p≈Øvodn√≠ hodnotu p≈ôi chybƒõ
                selectElement.value = currentRole || '';
            }
        }

        // Funkce pro reset hesla (e-mailem)
        async function resetUserPassword(email) {
            if (!confirm('Opravdu chcete odeslat e-mail pro reset hesla na adresu: ' + email + '?')) return;
            try {
                await sendPasswordResetEmail(auth, email);
                alert('E-mail pro reset hesla byl odesl√°n na adresu: ' + email);
            } catch (error) {
                console.error('Chyba p≈ôi resetu hesla:', error);
                alert('Nepoda≈ôilo se odeslat e-mail pro reset hesla: ' + error.message);
            }
        }

        // Funkce pro smaz√°n√≠ u≈æivatele
        async function deleteUser(userId, userEmail) {
            if (currentUserRole !== 'admin') {
                alert('Nem√°te opr√°vnƒõn√≠ mazat u≈æivatele');
                return;
            }
            
            if (!confirm(`Opravdu chcete smazat u≈æivatele ${userEmail}?\n\nTato akce je nevratn√° a sma≈æe:\n- U≈æivatelsk√Ω √∫ƒçet z datab√°ze\n- V≈°echny transakce u≈æivatele\n- V≈°echny z√°znamy o v√Ωplat√°ch\n\nPokraƒçovat?`)) {
                return;
            }
            
            try {
                // Smazat u≈æivatele z kolekce users
                await deleteDoc(doc(db, 'users', userId));
                
                // Smazat v≈°echny transakce u≈æivatele
                const transactionsQuery = query(
                    collection(db, 'stockTransactions'),
                    where('userId', '==', userId)
                );
                const transactionsSnapshot = await getDocs(transactionsQuery);
                const deleteTransactions = transactionsSnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deleteTransactions);
                
                // Smazat v≈°echny z√°znamy o v√Ωplat√°ch
                const salaryPaymentsQuery = query(
                    collection(db, 'salaryPayments'),
                    where('userId', '==', userId)
                );
                const salaryPaymentsSnapshot = await getDocs(salaryPaymentsQuery);
                const deleteSalaryPayments = salaryPaymentsSnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deleteSalaryPayments);
                
                alert(`U≈æivatel ${userEmail} byl √∫spƒõ≈°nƒõ smaz√°n vƒçetnƒõ v≈°ech jeho dat.`);
                
                // Znovu naƒç√≠st seznam u≈æivatel≈Ø
                await loadUsers();
            } catch (error) {
                console.error('Chyba p≈ôi maz√°n√≠ u≈æivatele:', error);
                alert('Nepoda≈ôilo se smazat u≈æivatele: ' + error.message);
            }
        }

        // Naƒçten√≠ seznamu u≈æivatel≈Ø
        async function loadUsers() {
            if (usersUnsubscribe) usersUnsubscribe();

            try {
                // Naƒç√≠st v≈°echny role z datab√°ze
                const rolesRef = doc(db, 'settings', 'roles');
                const rolesDoc = await getDoc(rolesRef);
                const defaultRoles = {
                    user: { name: 'U≈æivatel', percentage: 0 },
                    moderator: { name: 'Moder√°tor', percentage: 0 },
                    admin: { name: 'Administr√°tor', percentage: 0 }
                };
                const dbRoles = rolesDoc.exists() ? rolesDoc.data() : {};
                const allRoles = { ...defaultRoles, ...dbRoles };
                
                // Naƒç√≠st v≈°echny u≈æivatele z kolekce users
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const usersMap = new Map();
                
                // P≈ôidat u≈æivatele z kolekce users
                usersSnapshot.forEach(userDoc => {
                    const userData = userDoc.data();
                    usersMap.set(userDoc.id, {
                        id: userDoc.id,
                        email: userData.email || '',
                        role: userData.role || 'user',
                        createdAt: userData.createdAt,
                        fromUsers: true
                    });
                });

                // Naƒç√≠st v≈°echny pozn√°mky a z√≠skat unik√°tn√≠ u≈æivatele
                const notesSnapshot = await getDocs(collection(db, 'notes'));
                const usersFromNotes = new Map();
                
                notesSnapshot.forEach(noteDoc => {
                    const noteData = noteDoc.data();
                    if (noteData.userId && noteData.userEmail) {
                        usersFromNotes.set(noteData.userId, {
                            id: noteData.userId,
                            email: noteData.userEmail,
                            role: 'user', // v√Ωchoz√≠ role
                            createdAt: null,
                            fromUsers: false
                        });
                    }
                });

                // Slouƒçit u≈æivatele - d√°t p≈ôednost dat≈Øm z kolekce users
                usersFromNotes.forEach((user, userId) => {
                    if (!usersMap.has(userId)) {
                        // Pokud u≈æivatel nem√° z√°znam v users, p≈ôidat ho
                        usersMap.set(userId, user);
                    }
                });

                // P≈ôev√©st Map na pole a se≈ôadit podle emailu
                const users = Array.from(usersMap.values()).sort((a, b) => {
                    return (a.email || '').localeCompare(b.email || '');
                });

                const usersList = document.getElementById('usersList');
                if (users.length === 0) {
                    usersList.innerHTML = '<div class="empty-state"><p>Zat√≠m nejsou ≈æ√°dn√≠ u≈æivatel√©.</p></div>';
                } else {
                    // Pro ka≈æd√©ho u≈æivatele vypoƒç√≠tat v√Ωplatu
                    const usersWithSalary = await Promise.all(users.map(async (user) => {
                        const userRole = user.role || null;
                        let salaryAmount = 0;
                        let totalEarned = 0;
                        
                        if (userRole && (currentUserRole === 'admin' || currentUserRole === 'moderator')) {
                            // Vypoƒç√≠tat v√Ωplatu pro u≈æivatele
                            totalEarned = await calculateUserMoneyEarned(user.id);
                            const rolePercentage = allRoles[userRole]?.percentage || 0;
                            salaryAmount = (totalEarned * rolePercentage) / 100;
                        }
                        
                        return {
                            ...user,
                            salaryAmount: salaryAmount,
                            totalEarned: totalEarned
                        };
                    }));
                    
                    usersList.innerHTML = usersWithSalary.map(user => {
                        const userRole = user.role || null; // null pokud nem√° roli
                        const roleClass = userRole ? 'role-' + userRole : 'role-none';
                        const roleDisplay = userRole || '(bez role)';
                        
                        // Vytvo≈ôit options pro v≈°echny role + mo≈ænost "Bez role"
                        let roleOptions = '<option value="" ' + (!userRole ? 'selected' : '') + '>Bez role</option>';
                        roleOptions += Object.keys(allRoles).map(roleKey => {
                            const role = allRoles[roleKey];
                            const roleName = role.name || roleKey;
                            const isSelected = userRole === roleKey ? 'selected' : '';
                            return `<option value="${roleKey}" ${isSelected}>${roleName}</option>`;
                        }).join('');
                        
                        // Zobrazit ƒç√°stku v√Ωplaty, pokud je k dispozici
                        const salaryDisplay = user.salaryAmount > 0 
                            ? `<span style="color: #4caf50; font-weight: 600; margin-right: 10px; font-size: 14px;">üí∞ ${user.salaryAmount.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Kƒç</span>`
                            : '';
                        
                        return `
                            <div class="user-card">
                                <div class="user-header">
                                    <div class="user-info">
                                        <h3>${user.email || 'Nezn√°m√Ω u≈æivatel'} <span class="role-badge ${roleClass}" style="${!userRole ? 'background: #999; color: white;' : ''}">${roleDisplay}</span></h3>
                                        <p class="user-email-text">U≈æivatel ID: ${user.id.substring(0, 8)}...</p>
                                    </div>
                                    <div class="user-actions">
                                        <select id="roleSelect_${user.id.replace(/[^a-zA-Z0-9]/g, '_')}" class="btn-small" data-current-role="${userRole || ''}" data-user-id="${user.id}" data-user-email="${(user.email || '').replace(/'/g, "\\'")}">
                                            ${roleOptions}
                                        </select>
                                        ${(currentUserRole === 'admin' || currentUserRole === 'moderator') ? `${salaryDisplay}<button class="btn-small" style="background: #4caf50; color: white;" onclick="event.stopPropagation(); paySalaryToUser('${user.id.replace(/'/g, "\\'")}', '${(user.email || '').replace(/'/g, "\\'")}', '${userRole}')" title="D√°t v√Ωplatu">üí∞ D√°t v√Ωplatu</button>` : ''}
                                        ${currentUserRole === 'admin' ? `<button class="btn-small btn-reset" onclick="event.stopPropagation(); resetUserPassword('${(user.email || '').replace(/'/g, "\\'")}')" ${!user.email ? 'disabled' : ''}>Resetovat heslo</button>` : ''}
                                        ${currentUserRole === 'admin' ? `<button class="btn-small" style="background: #f44336; color: white;" onclick="event.stopPropagation(); deleteUser('${user.id.replace(/'/g, "\\'")}', '${(user.email || '').replace(/'/g, "\\'")}')" title="Smazat u≈æivatele">üóëÔ∏è Smazat</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Nastavit listener pro real-time updates (pouze pro zmƒõny, ne p≈ôi prvn√≠m naƒçten√≠)
                const q = query(collection(db, 'users'));
                let isFirstLoad = true;
                usersUnsubscribe = onSnapshot(q, async (snapshot) => {
                    if (isFirstLoad) {
                        isFirstLoad = false;
                        return; // P≈ôi prvn√≠m naƒçten√≠ u≈æ m√°me data
                    }
                    // P≈ôi zmƒõnƒõ v kolekci users znovu naƒç√≠st
                    await loadUsers();
                });

            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ u≈æivatel≈Ø:', error);
                document.getElementById('usersList').innerHTML = '<div class="empty-state"><p>Chyba p≈ôi naƒç√≠t√°n√≠ u≈æivatel≈Ø: ' + error.message + '</p></div>';
            }
        }

        // P≈ôep√≠n√°n√≠ tabs v admin panelu
        async function showAdminTab(tab) {
            const dashboardSection = document.getElementById('adminDashboardSection');
            const notesSection = document.getElementById('adminNotesSection');
            const rolesSection = document.getElementById('adminRolesSection');
            const usersSection = document.getElementById('adminUsersSection');
            const dashboardTab = document.getElementById('adminTabDashboard');
            const notesTab = document.getElementById('adminTabNotes');
            const rolesTab = document.getElementById('adminTabRoles');
            const usersTab = document.getElementById('adminTabUsers');
            
            // Skr√Ωt v≈°echny sekce
            if (dashboardSection) dashboardSection.style.display = 'none';
            if (notesSection) notesSection.style.display = 'none';
            if (rolesSection) rolesSection.style.display = 'none';
            if (usersSection) usersSection.style.display = 'none';
            
            // Odstranit active z v≈°ech tab≈Ø
            if (dashboardTab) dashboardTab.classList.remove('active');
            if (notesTab) notesTab.classList.remove('active');
            if (rolesTab) rolesTab.classList.remove('active');
            if (usersTab) usersTab.classList.remove('active');
            
            if (tab === 'dashboard') {
                if (dashboardSection) dashboardSection.style.display = 'block';
                if (dashboardTab) dashboardTab.classList.add('active');
                loadDashboard();
            } else if (tab === 'notes') {
                if (notesSection) notesSection.style.display = 'block';
                if (notesTab) notesTab.classList.add('active');
                loadAdminNotes();
            } else if (tab === 'roles') {
                if (rolesSection) rolesSection.style.display = 'block';
                if (rolesTab) rolesTab.classList.add('active');
                if (currentUserRole === 'admin' || currentUserRole === 'moderator') {
                    await loadRoles();
                }
            } else if (tab === 'users') {
                if (usersSection) usersSection.style.display = 'block';
                if (usersTab) usersTab.classList.add('active');
                if (currentUserRole === 'admin') {
                    await loadUsers();
                }
            }
        }

        // Naƒçten√≠ dashboardu se statistikami
        async function loadDashboard() {
            try {
                const q = query(collection(db, 'stockTransactions'));
                const snapshot = await getDocs(q);
                const transactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);

                // Z√°kladn√≠ statistiky
                const totalTransactions = transactions.length;
                const uniqueUsers = [...new Set(transactions.map(t => t.userEmail))];
                const todayTransactions = transactions.filter(t => {
                    if (!t.createdAt) return false;
                    return t.createdAt.toDate() >= today;
                }).length;
                const weekTransactions = transactions.filter(t => {
                    if (!t.createdAt) return false;
                    return t.createdAt.toDate() >= weekAgo;
                }).length;

                document.getElementById('dashboardTotalTransactions').textContent = totalTransactions;
                document.getElementById('dashboardActiveUsers').textContent = uniqueUsers.length;
                document.getElementById('dashboardTodayTransactions').textContent = todayTransactions;
                document.getElementById('dashboardWeekTransactions').textContent = weekTransactions;

                // Nejaktivnƒõj≈°√≠ u≈æivatel√©
                const userActivity = {};
                transactions.forEach(t => {
                    if (!userActivity[t.userEmail]) {
                        userActivity[t.userEmail] = 0;
                    }
                    userActivity[t.userEmail]++;
                });
                const topUsers = Object.entries(userActivity)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                const topUsersHtml = topUsers.map(([email, count], index) => `
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: white; margin-bottom: 8px; border-radius: 6px;">
                        <span>${index + 1}. ${email}</span>
                        <strong style="color: #667eea;">${count} transakc√≠</strong>
                    </div>
                `).join('');
                document.getElementById('dashboardTopUsers').innerHTML = topUsersHtml || '<p style="color: #666;">Zat√≠m ≈æ√°dn√° data</p>';

                // Rozdƒõlen√≠ podle typu
                const byType = { money: 0, tickets: 0, bags: 0 };
                transactions.forEach(t => {
                    if (byType[t.itemType] !== undefined) {
                        byType[t.itemType]++;
                    }
                });
                const typeNames = { money: 'Pen√≠ze', tickets: 'Koka-listky', bags: 'S√°ƒçky' };
                const byTypeHtml = Object.entries(byType).map(([type, count]) => `
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: white; margin-bottom: 8px; border-radius: 6px;">
                        <span>${typeNames[type]}</span>
                        <strong style="color: #667eea;">${count} transakc√≠</strong>
                    </div>
                `).join('');
                document.getElementById('dashboardByType').innerHTML = byTypeHtml || '<p style="color: #666;">Zat√≠m ≈æ√°dn√° data</p>';

                // Aktivita podle dne (posledn√≠ch 7 dn√≠)
                const dailyActivity = {};
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    dailyActivity[dateStr] = 0;
                }

                transactions.forEach(t => {
                    if (!t.createdAt) return;
                    const transDate = t.createdAt.toDate();
                    const dateStr = transDate.toISOString().split('T')[0];
                    if (dailyActivity[dateStr] !== undefined) {
                        dailyActivity[dateStr]++;
                    }
                });

                const maxActivity = Math.max(...Object.values(dailyActivity), 1);
                const chartHtml = Object.entries(dailyActivity).map(([date, count]) => {
                    const dateObj = new Date(date);
                    const dayName = dateObj.toLocaleDateString('cs-CZ', { weekday: 'short' });
                    const dayNum = dateObj.getDate();
                    const height = (count / maxActivity) * 150;
                    return `
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="width: 100%; max-width: 40px; background: #e0e0e0; border-radius: 4px 4px 0 0; position: relative; height: 150px; display: flex; align-items: flex-end;">
                                <div style="width: 100%; background: #667eea; height: ${height}px; border-radius: 4px 4px 0 0;"></div>
                            </div>
                            <div style="margin-top: 8px; text-align: center; font-size: 12px;">
                                <div style="font-weight: bold;">${count}</div>
                                <div style="color: #666;">${dayName}</div>
                                <div style="color: #999; font-size: 10px;">${dayNum}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                const chartContainer = document.getElementById('dashboardActivityChart');
                chartContainer.innerHTML = `<div style="display: flex; gap: 10px; justify-content: space-around; align-items: flex-end;">${chartHtml}</div>`;

            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ dashboardu:', error);
            }
        }

        // Funkce pro aplikov√°n√≠ filtr≈Ø v admin panelu
        function applyAdminFilters() {
            const userFilter = document.getElementById('adminFilterUser');
            const typeFilter = document.getElementById('adminFilterType');
            const dateFilter = document.getElementById('adminFilterDate');
            const dateFrom = document.getElementById('adminFilterDateFrom');
            const dateTo = document.getElementById('adminFilterDateTo');
            const searchInput = document.getElementById('adminSearch');
            const customDateRange = document.getElementById('customDateRange');
            
            adminFilterUser = userFilter ? userFilter.value : '';
            adminFilterType = typeFilter ? typeFilter.value : '';
            adminFilterDate = dateFilter ? dateFilter.value : '';
            adminFilterDateFrom = dateFrom ? dateFrom.value : '';
            adminFilterDateTo = dateTo ? dateTo.value : '';
            adminSearch = searchInput ? searchInput.value : '';
            
            // Zobrazit/skr√Ωt vlastn√≠ rozsah dat
            if (customDateRange) {
                customDateRange.style.display = adminFilterDate === 'custom' ? 'block' : 'none';
            }
            
            currentPage = 1; // Resetovat str√°nku p≈ôi zmƒõnƒõ filtr≈Ø
            
            // Znovu naƒç√≠st admin pozn√°mky s filtry
            loadAdminNotes();
        }

        // Funkce pro zru≈°en√≠ filtr≈Ø
        function clearAdminFilters() {
            adminFilterUser = '';
            adminFilterType = '';
            adminFilterDate = '';
            adminFilterDateFrom = '';
            adminFilterDateTo = '';
            adminSearch = '';
            
            const userFilter = document.getElementById('adminFilterUser');
            const typeFilter = document.getElementById('adminFilterType');
            const dateFilter = document.getElementById('adminFilterDate');
            const dateFrom = document.getElementById('adminFilterDateFrom');
            const dateTo = document.getElementById('adminFilterDateTo');
            const searchInput = document.getElementById('adminSearch');
            const customDateRange = document.getElementById('customDateRange');
            
            if (userFilter) userFilter.value = '';
            if (typeFilter) typeFilter.value = '';
            if (dateFilter) dateFilter.value = '';
            if (dateFrom) dateFrom.value = '';
            if (dateTo) dateTo.value = '';
            if (searchInput) searchInput.value = '';
            if (customDateRange) customDateRange.style.display = 'none';
            
            currentPage = 1;
            
            // Znovu naƒç√≠st admin pozn√°mky bez filtr≈Ø
            loadAdminNotes();
        }

        // Make functions global
        // Funkce pro zmƒõnu str√°nky v admin panelu
        function changeAdminPage(page) {
            if (page < 1) return;
            currentPage = page;
            loadAdminNotes();
        }

        // Funkce pro zmƒõnu str√°nky u u≈æivatele
        function changeUserPage(page) {
            if (page < 1) return;
            currentUserPage = page;
            const q = query(collection(db, 'stockTransactions'));
            getDocs(q).then(snapshot => {
                const transactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                loadMyTransactions(transactions);
            });
        }

        // Funkce pro u≈æivatelsk√© filtry
        function applyUserFilters() {
            const typeFilter = document.getElementById('userFilterType');
            const dateFilter = document.getElementById('userFilterDate');
            const dateFrom = document.getElementById('userFilterDateFrom');
            const dateTo = document.getElementById('userFilterDateTo');
            const searchInput = document.getElementById('userSearch');
            const customDateRange = document.getElementById('userCustomDateRange');
            
            userFilterType = typeFilter ? typeFilter.value : '';
            userFilterDate = dateFilter ? dateFilter.value : '';
            userFilterDateFrom = dateFrom ? dateFrom.value : '';
            userFilterDateTo = dateTo ? dateTo.value : '';
            userSearch = searchInput ? searchInput.value : '';
            
            if (customDateRange) {
                customDateRange.style.display = userFilterDate === 'custom' ? 'block' : 'none';
            }
            
            currentUserPage = 1;
            
            const q = query(collection(db, 'stockTransactions'));
            getDocs(q).then(snapshot => {
                const transactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                loadMyTransactions(transactions);
            });
        }

        function clearUserFilters() {
            userFilterType = '';
            userFilterDate = '';
            userFilterDateFrom = '';
            userFilterDateTo = '';
            userSearch = '';
            
            const typeFilter = document.getElementById('userFilterType');
            const dateFilter = document.getElementById('userFilterDate');
            const dateFrom = document.getElementById('userFilterDateFrom');
            const dateTo = document.getElementById('userFilterDateTo');
            const searchInput = document.getElementById('userSearch');
            const customDateRange = document.getElementById('userCustomDateRange');
            
            if (typeFilter) typeFilter.value = '';
            if (dateFilter) dateFilter.value = '';
            if (dateFrom) dateFrom.value = '';
            if (dateTo) dateTo.value = '';
            if (searchInput) searchInput.value = '';
            if (customDateRange) customDateRange.style.display = 'none';
            
            currentUserPage = 1;
            
            const q = query(collection(db, 'stockTransactions'));
            getDocs(q).then(snapshot => {
                const transactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                loadMyTransactions(transactions);
            });
        }

        // Funkce pro editaci transakce
        async function editTransaction(transactionId) {
            try {
                const transactionDoc = await getDoc(doc(db, 'stockTransactions', transactionId));
                if (!transactionDoc.exists()) {
                    alert('Transakce nebyla nalezena');
                    return;
                }
                
                const transaction = transactionDoc.data();
                const newNote = prompt('Upravit pozn√°mku:', transaction.note || '');
                
                if (newNote !== null) {
                    await setDoc(doc(db, 'stockTransactions', transactionId), {
                        ...transaction,
                        note: newNote,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    alert('Pozn√°mka byla upravena');
                }
            } catch (error) {
                alert('Chyba p≈ôi √∫pravƒõ transakce: ' + error.message);
            }
        }

        // Funkce pro smaz√°n√≠ transakce
        async function deleteTransaction(transactionId) {
            if (!confirm('Opravdu chcete smazat tuto transakci? Tato akce je nevratn√° a ovlivn√≠ aktu√°ln√≠ stav skladu!')) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'stockTransactions', transactionId));
                alert('Transakce byla smaz√°na');
            } catch (error) {
                alert('Chyba p≈ôi maz√°n√≠ transakce: ' + error.message);
            }
        }

        // Export do CSV pro admin
        async function exportToCSV() {
            try {
                const q = query(collection(db, 'stockTransactions'));
                const snapshot = await getDocs(q);
                const transactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })).sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                let filtered = transactions;
                if (adminFilterUser) filtered = filtered.filter(t => t.userEmail === adminFilterUser);
                if (adminFilterType) filtered = filtered.filter(t => t.itemType === adminFilterType);
                if (adminFilterDate) {
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    filtered = filtered.filter(t => {
                        if (!t.createdAt) return false;
                        const transDate = t.createdAt.toDate();
                        if (adminFilterDate === 'today') return transDate >= today;
                        if (adminFilterDate === 'week') {
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            return transDate >= weekAgo;
                        }
                        if (adminFilterDate === 'month') {
                            const monthAgo = new Date(today);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            return transDate >= monthAgo;
                        }
                        if (adminFilterDate === 'custom' && adminFilterDateFrom && adminFilterDateTo) {
                            const fromDate = new Date(adminFilterDateFrom);
                            const toDate = new Date(adminFilterDateTo);
                            toDate.setHours(23, 59, 59, 999);
                            return transDate >= fromDate && transDate <= toDate;
                        }
                        return true;
                    });
                }
                if (adminSearch) {
                    const searchLower = adminSearch.toLowerCase();
                    filtered = filtered.filter(t => {
                        const note = (t.note || '').toLowerCase();
                        const userEmail = (t.userEmail || '').toLowerCase();
                        return note.includes(searchLower) || userEmail.includes(searchLower);
                    });
                }

                const headers = ['Datum', 'U≈æivatel', 'Typ polo≈æky', 'Operace', 'Mno≈æstv√≠', 'Pozn√°mka'];
                const rows = filtered.map(t => {
                    const date = t.createdAt ? formatDate(t.createdAt) : '';
                    const itemType = t.itemType === 'money' ? 'Pen√≠ze' : t.itemType === 'tickets' ? 'Koka-listky' : 'S√°ƒçky';
                    const operation = t.operation === 'add' ? 'Ulo≈æil' : t.operation === 'remove' ? 'Vzal' : 'Nastavil';
                    return [date, t.userEmail || '', itemType, operation, t.amount || '', t.note || ''];
                });

                const csvContent = [headers, ...rows].map(row => 
                    row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
                ).join('\n');

                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `transakce_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            } catch (error) {
                alert('Chyba p≈ôi exportu: ' + error.message);
            }
        }

        // Export do CSV pro u≈æivatele
        async function exportMyTransactionsToCSV() {
            try {
                const q = query(collection(db, 'stockTransactions'));
                const snapshot = await getDocs(q);
                const allTransactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                let myTransactions = allTransactions.filter(t => t.userId === currentUser.uid);
                
                if (userFilterType) myTransactions = myTransactions.filter(t => t.itemType === userFilterType);
                if (userFilterDate) {
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    myTransactions = myTransactions.filter(t => {
                        if (!t.createdAt) return false;
                        const transDate = t.createdAt.toDate();
                        if (userFilterDate === 'today') return transDate >= today;
                        if (userFilterDate === 'week') {
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            return transDate >= weekAgo;
                        }
                        if (userFilterDate === 'month') {
                            const monthAgo = new Date(today);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            return transDate >= monthAgo;
                        }
                        if (userFilterDate === 'custom' && userFilterDateFrom && userFilterDateTo) {
                            const fromDate = new Date(userFilterDateFrom);
                            const toDate = new Date(userFilterDateTo);
                            toDate.setHours(23, 59, 59, 999);
                            return transDate >= fromDate && transDate <= toDate;
                        }
                        return true;
                    });
                }
                if (userSearch) {
                    const searchLower = userSearch.toLowerCase();
                    myTransactions = myTransactions.filter(t => {
                        const note = (t.note || '').toLowerCase();
                        return note.includes(searchLower);
                    });
                }

                const headers = ['Datum', 'Typ polo≈æky', 'Operace', 'Mno≈æstv√≠', 'Pozn√°mka'];
                const rows = myTransactions.map(t => {
                    const date = t.createdAt ? formatDate(t.createdAt) : '';
                    const itemType = t.itemType === 'money' ? 'Pen√≠ze' : t.itemType === 'tickets' ? 'Koka-listky' : 'S√°ƒçky';
                    const operation = t.operation === 'add' ? 'Ulo≈æil' : t.operation === 'remove' ? 'Vzal' : 'Nastavil';
                    return [date, itemType, operation, t.amount || '', t.note || ''];
                });

                const csvContent = [headers, ...rows].map(row => 
                    row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
                ).join('\n');

                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `moje_transakce_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            } catch (error) {
                alert('Chyba p≈ôi exportu: ' + error.message);
            }
        }

        // Make functions global
        window.changeUserRole = changeUserRole;
        window.resetUserPassword = resetUserPassword;
        window.deleteUser = deleteUser;
        window.showAdminTab = showAdminTab;
        window.applyAdminFilters = applyAdminFilters;
        window.clearAdminFilters = clearAdminFilters;
        window.changeAdminPage = changeAdminPage;
        window.changeUserPage = changeUserPage;
        window.applyUserFilters = applyUserFilters;
        window.clearUserFilters = clearUserFilters;
        window.editTransaction = editTransaction;
        window.deleteTransaction = deleteTransaction;
        window.exportToCSV = exportToCSV;
        window.exportMyTransactionsToCSV = exportMyTransactionsToCSV;
        window.updateRolePercentage = updateRolePercentage;
        window.createNewRole = createNewRole;
        window.deleteRole = deleteRole;
        window.paySalaryToUser = paySalaryToUser;

        // Naƒçten√≠ a zobrazen√≠ rol√≠ s procenty
        async function loadRoles() {
            try {
                const rolesRef = doc(db, 'settings', 'roles');
                const rolesDoc = await getDoc(rolesRef);
                
                const defaultRoles = {
                    user: { name: 'U≈æivatel', percentage: 0, isDefault: true },
                    moderator: { name: 'Moder√°tor', percentage: 0, isDefault: true },
                    admin: { name: 'Administr√°tor', percentage: 0, isDefault: true }
                };
                
                // Naƒç√≠st v≈°echny role z datab√°ze
                const dbRoles = rolesDoc.exists() ? rolesDoc.data() : {};
                
                // Slouƒçit v√Ωchoz√≠ role s rolemi z datab√°ze
                const allRoles = { ...defaultRoles, ...dbRoles };
                
                const rolesList = document.getElementById('rolesList');
                rolesList.innerHTML = Object.keys(allRoles).map(roleKey => {
                    const role = allRoles[roleKey];
                    const percentage = role.percentage || 0;
                    const isDefault = role.isDefault || defaultRoles[roleKey]?.isDefault || false;
                    
                    return `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid ${isDefault ? '#667eea' : '#ff9800'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <h3 style="color: #333; margin: 0; display: inline-block;">${role.name}</h3>
                                    ${isDefault ? '<span style="color: #999; font-size: 11px; margin-left: 10px;">(v√Ωchoz√≠)</span>' : ''}
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <span class="role-badge role-${roleKey}">${roleKey}</span>
                                    ${!isDefault ? `<button onclick="deleteRole('${roleKey}')" class="btn-small" style="background: #f44336; color: white; padding: 6px 12px; font-size: 12px;" title="Smazat roli">üóëÔ∏è</button>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <label style="flex: 1; color: #666;">Procento z v√Ωdƒõlku:</label>
                                <input type="number" id="role_${roleKey}" value="${percentage}" min="0" max="100" step="0.1" 
                                       style="width: 100px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                <span style="color: #666; font-weight: 600;">%</span>
                                <button onclick="updateRolePercentage('${roleKey}')" class="btn-small" style="background: #4caf50; color: white; padding: 8px 16px;">
                                    Ulo≈æit
                                </button>
                            </div>
                            <p style="color: #999; font-size: 12px; margin-top: 10px; margin-bottom: 0;">
                                U≈æivatel√© s touto rol√≠ dostanou ${percentage}% z penƒõz, kter√© p≈ôinesli do skladu.
                            </p>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ rol√≠:', error);
                document.getElementById('rolesList').innerHTML = '<div class="empty-state"><p>Chyba p≈ôi naƒç√≠t√°n√≠ rol√≠: ' + error.message + '</p></div>';
            }
        }

        // Vytvo≈ôen√≠ nov√© role
        async function createNewRole() {
            if (currentUserRole !== 'admin' && currentUserRole !== 'moderator') {
                alert('Nem√°te opr√°vnƒõn√≠ vytv√°≈ôet role');
                return;
            }
            
            const nameInput = document.getElementById('newRoleName');
            const percentageInput = document.getElementById('newRolePercentage');
            
            const name = nameInput.value.trim();
            const percentage = parseFloat(percentageInput.value);
            
            if (!name) {
                alert('Zadejte n√°zev role');
                nameInput.focus();
                return;
            }
            
            if (isNaN(percentage) || percentage < 0 || percentage > 100) {
                alert('Procento mus√≠ b√Ωt mezi 0 a 100');
                percentageInput.focus();
                return;
            }
            
            // Vytvo≈ôit kl√≠ƒç role (mal√Ωmi p√≠smeny, bez mezer, s podtr≈æ√≠tky)
            const roleKey = name.toLowerCase()
                .replace(/\s+/g, '_')
                .replace(/[^a-z0-9_]/g, '');
            
            if (!roleKey) {
                alert('N√°zev role mus√≠ obsahovat alespo≈à jedno p√≠smeno');
                nameInput.focus();
                return;
            }
            
            // Kontrola, zda role u≈æ neexistuje
            const rolesRef = doc(db, 'settings', 'roles');
            const rolesDoc = await getDoc(rolesRef);
            const existingRoles = rolesDoc.exists() ? rolesDoc.data() : {};
            
            if (existingRoles[roleKey]) {
                alert(`Role s kl√≠ƒçem "${roleKey}" ji≈æ existuje!`);
                return;
            }
            
            // Kontrola v√Ωchoz√≠ch rol√≠
            const defaultRoleKeys = ['user', 'moderator', 'admin'];
            if (defaultRoleKeys.includes(roleKey)) {
                alert(`Role "${roleKey}" je v√Ωchoz√≠ role a nelze ji vytvo≈ôit znovu.`);
                return;
            }
            
            try {
                await setDoc(rolesRef, {
                    ...existingRoles,
                    [roleKey]: {
                        name: name,
                        percentage: percentage,
                        isDefault: false,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    }
                }, { merge: true });
                
                alert(`Role "${name}" byla √∫spƒõ≈°nƒõ vytvo≈ôena!`);
                
                // Vyƒçistit formul√°≈ô
                nameInput.value = '';
                percentageInput.value = '0';
                
                // Znovu naƒç√≠st role
                await loadRoles();
            } catch (error) {
                console.error('Chyba p≈ôi vytv√°≈ôen√≠ role:', error);
                alert('Nepoda≈ôilo se vytvo≈ôit roli: ' + error.message);
            }
        }

        // Smaz√°n√≠ role
        async function deleteRole(roleKey) {
            if (currentUserRole !== 'admin' && currentUserRole !== 'moderator') {
                alert('Nem√°te opr√°vnƒõn√≠ mazat role');
                return;
            }
            
            const rolesRef = doc(db, 'settings', 'roles');
            const rolesDoc = await getDoc(rolesRef);
            const roles = rolesDoc.exists() ? rolesDoc.data() : {};
            const role = roles[roleKey];
            
            if (!role) {
                alert('Role nenalezena');
                return;
            }
            
            // Nelze smazat v√Ωchoz√≠ role
            if (role.isDefault) {
                alert('Nelze smazat v√Ωchoz√≠ roli');
                return;
            }
            
            if (!confirm(`Opravdu chcete smazat roli "${role.name}" (${roleKey})? Tato akce je nevratn√° a u≈æivatel√© s touto rol√≠ budou muset dostat jinou roli.`)) {
                return;
            }
            
            try {
                // Odstranit roli z datab√°ze
                const updatedRoles = { ...roles };
                delete updatedRoles[roleKey];
                
                await setDoc(rolesRef, updatedRoles);
                
                alert(`Role "${role.name}" byla √∫spƒõ≈°nƒõ smaz√°na!`);
                
                // Znovu naƒç√≠st role
                await loadRoles();
            } catch (error) {
                console.error('Chyba p≈ôi maz√°n√≠ role:', error);
                alert('Nepoda≈ôilo se smazat roli: ' + error.message);
            }
        }

        // Aktualizace procenta role
        async function updateRolePercentage(roleKey) {
            if (currentUserRole !== 'admin' && currentUserRole !== 'moderator') {
                alert('Nem√°te opr√°vnƒõn√≠ mƒõnit procenta rol√≠');
                return;
            }
            
            const input = document.getElementById(`role_${roleKey}`);
            const percentage = parseFloat(input.value);
            
            if (isNaN(percentage) || percentage < 0 || percentage > 100) {
                alert('Procento mus√≠ b√Ωt mezi 0 a 100');
                input.focus();
                return;
            }
            
            try {
                const rolesRef = doc(db, 'settings', 'roles');
                const rolesDoc = await getDoc(rolesRef);
                const currentRoles = rolesDoc.exists() ? rolesDoc.data() : {};
                
                const roleNames = {
                    user: 'U≈æivatel',
                    moderator: 'Moder√°tor',
                    admin: 'Administr√°tor'
                };
                
                await setDoc(rolesRef, {
                    ...currentRoles,
                    [roleKey]: {
                        name: roleNames[roleKey],
                        percentage: percentage,
                        updatedAt: serverTimestamp()
                    }
                }, { merge: true });
                
                alert(`Procento pro roli "${roleNames[roleKey]}" bylo √∫spƒõ≈°nƒõ nastaveno na ${percentage}%`);
                await loadRoles(); // Znovu naƒç√≠st pro aktualizaci popisku
            } catch (error) {
                console.error('Chyba p≈ôi ukl√°d√°n√≠ procenta role:', error);
                alert('Nepoda≈ôilo se ulo≈æit procento: ' + error.message);
            }
        }

        // V√Ωpoƒçet celkov√© ƒç√°stky penƒõz p≈ôinesen√Ωch u≈æivatelem (m√≠nus ji≈æ vyplacen√©)
        async function calculateUserMoneyEarned(userId) {
            try {
                // Naƒç√≠st v≈°echny transakce typu "add" pro pen√≠ze
                const q = query(
                    collection(db, 'stockTransactions'),
                    where('userId', '==', userId),
                    where('itemType', '==', 'money'),
                    where('operation', '==', 'add')
                );
                const snapshot = await getDocs(q);
                
                let total = 0;
                snapshot.forEach(doc => {
                    const transaction = doc.data();
                    total += transaction.amount || 0;
                });
                
                // Odeƒç√≠st ji≈æ vyplacen√© ƒç√°stky (odeƒç√≠t√°me totalEarned, ne amount, aby se to √∫plnƒõ vynulovalo)
                const salaryPaymentsQuery = query(
                    collection(db, 'salaryPayments'),
                    where('userId', '==', userId)
                );
                const salaryPaymentsSnapshot = await getDocs(salaryPaymentsQuery);
                
                let totalPaid = 0;
                salaryPaymentsSnapshot.forEach(doc => {
                    const payment = doc.data();
                    // Odeƒç√≠t√°me totalEarned (kolik p≈ôinesl), ne amount (kolik dostal), aby se to √∫plnƒõ vynulovalo
                    totalPaid += payment.totalEarned || 0;
                });
                
                // Vr√°tit rozd√≠l (co je≈°tƒõ zb√Ωv√° k v√Ωplatƒõ)
                return Math.max(0, total - totalPaid);
            } catch (error) {
                console.error('Chyba p≈ôi v√Ωpoƒçtu penƒõz u≈æivatele:', error);
                return 0;
            }
        }

        // D√°t v√Ωplatu u≈æivateli
        async function paySalaryToUser(userId, userEmail, userRole) {
            if (currentUserRole !== 'admin' && currentUserRole !== 'moderator') {
                alert('Nem√°te opr√°vnƒõn√≠ d√°vat v√Ωplaty');
                return;
            }
            
            try {
                // Z√≠skat roli u≈æivatele a procento
                const rolesRef = doc(db, 'settings', 'roles');
                const rolesDoc = await getDoc(rolesRef);
                const roles = rolesDoc.exists() ? rolesDoc.data() : {};
                const rolePercentage = roles[userRole]?.percentage || 0;
                
                // Vypoƒç√≠tat aktu√°ln√≠ v√Ωplatu
                const totalEarned = await calculateUserMoneyEarned(userId);
                const salary = (totalEarned * rolePercentage) / 100;
                
                if (salary <= 0) {
                    alert(`U≈æivatel ${userEmail} nem√° ≈æ√°dnou v√Ωplatu k vyplacen√≠.`);
                    return;
                }
                
                // Potvrdit v√Ωplatu
                if (!confirm(`Opravdu chcete d√°t v√Ωplatu u≈æivateli ${userEmail}?\n\nCelkem p≈ôineseno: ${totalEarned.toLocaleString('cs-CZ')} Kƒç\nProcento role: ${rolePercentage}%\nV√Ωplata: ${salary.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Kƒç\n\nTato akce vynuluje poƒç√≠tadlo p≈ôinesen√Ωch penƒõz pro v√Ωpoƒçet v√Ωplaty, ale pen√≠ze z≈Østanou na skladu.`)) {
                    return;
                }
                
                // Z√≠skat p≈ôezd√≠vku admina/moder√°tora z datab√°ze
                const paidByDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const paidByDisplayName = paidByDoc.exists() && paidByDoc.data().email ? paidByDoc.data().email : currentUser.email;
                
                // Vytvo≈ôit z√°znam o v√Ωplatƒõ
                await addDoc(collection(db, 'salaryPayments'), {
                    userId: userId,
                    userEmail: userEmail,
                    userRole: userRole,
                    amount: salary,
                    totalEarned: totalEarned,
                    rolePercentage: rolePercentage,
                    paidBy: paidByDisplayName,
                    paidByUserId: currentUser.uid,
                    paidAt: serverTimestamp(),
                    note: `V√Ωplata za p≈ôinesen√© pen√≠ze (${totalEarned.toLocaleString('cs-CZ')} Kƒç √ó ${rolePercentage}%)`
                });
                
                // Odeslat notifikaci na Discord
                try {
                    await sendSalaryPaymentNotification(userEmail, userRole, salary, totalEarned, rolePercentage, paidByDisplayName);
                } catch (error) {
                    console.error('Chyba p≈ôi odes√≠l√°n√≠ Discord notifikace:', error);
                    // Pokraƒçovat i kdy≈æ webhook sel≈æe
                }
                
                alert(`V√Ωplata ${salary.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Kƒç byla √∫spƒõ≈°nƒõ zaznamen√°na pro u≈æivatele ${userEmail}.\n\nPoƒç√≠tadlo p≈ôinesen√Ωch penƒõz bylo vynulov√°no pro v√Ωpoƒçet v√Ωplaty.`);
                
                // Znovu naƒç√≠st u≈æivatele pro aktualizaci zobrazen√≠
                await loadUsers();
            } catch (error) {
                console.error('Chyba p≈ôi v√Ωplatƒõ:', error);
                alert('Nepoda≈ôilo se d√°t v√Ωplatu: ' + error.message);
            }
        }

        // Zobrazen√≠ modalu s v√Ωplatou
        async function showSalaryModal() {
            if (!currentUser) return;
            
            try {
                // Z√≠skat roli u≈æivatele
                const userRole = await getUserRole(currentUser.uid);
                
                // Z√≠skat procento pro roli
                const rolesRef = doc(db, 'settings', 'roles');
                const rolesDoc = await getDoc(rolesRef);
                const roles = rolesDoc.exists() ? rolesDoc.data() : {};
                const rolePercentage = roles[userRole]?.percentage || 0;
                
                // Vypoƒç√≠tat celkovou ƒç√°stku p≈ôinesen√Ωch penƒõz
                const totalEarned = await calculateUserMoneyEarned(currentUser.uid);
                
                // Vypoƒç√≠tat v√Ωplatu
                const salary = (totalEarned * rolePercentage) / 100;
                
                // Zobrazit modal
                const modal = document.getElementById('salaryModal');
                const content = document.getElementById('salaryContent');
                
                content.innerHTML = `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <span style="color: #666;">Va≈°e role:</span>
                            <span class="role-badge role-${userRole}" style="font-weight: 600;">${userRole}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <span style="color: #666;">Procento z v√Ωdƒõlku:</span>
                            <span style="color: #333; font-weight: 600;">${rolePercentage}%</span>
                        </div>
                        <div style="border-top: 2px solid #e0e0e0; padding-top: 15px; margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #666;">Celkem p≈ôineseno penƒõz:</span>
                                <span style="color: #333; font-weight: 600; font-size: 18px;">${totalEarned.toLocaleString('cs-CZ')} Kƒç</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                                <span style="color: #333; font-weight: 600; font-size: 16px;">Va≈°e v√Ωplata:</span>
                                <span style="color: #4caf50; font-weight: bold; font-size: 24px;">${salary.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Kƒç</span>
                            </div>
                        </div>
                    </div>
                    <p style="color: #999; font-size: 12px; text-align: center; margin: 0;">
                        V√Ωplata se poƒç√≠t√° z penƒõz, kter√© jste p≈ôinesli do skladu pomoc√≠ operace "Ulo≈æit".
                    </p>
                `;
                
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ v√Ωplaty:', error);
                alert('Nepoda≈ôilo se naƒç√≠st informace o v√Ωplatƒõ: ' + error.message);
            }
        }

        // Zav≈ôen√≠ modalu s v√Ωplatou
        function closeSalaryModal() {
            const modal = document.getElementById('salaryModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }
        
        // P≈ôidat do window po definici funkce
        window.closeSalaryModal = closeSalaryModal;

        // Event listener pro tlaƒç√≠tko V√Ωplata
        document.getElementById('salaryBtn').addEventListener('click', () => {
            showSalaryModal();
        });

        // Zobrazit tab pro spr√°vu rol√≠ pouze pro adminy a moder√°tory
        function updateAdminTabsVisibility() {
            const rolesTab = document.getElementById('adminTabRoles');
            if (rolesTab) {
                if (currentUserRole === 'admin' || currentUserRole === 'moderator') {
                    rolesTab.style.display = 'inline-block';
                } else {
                    rolesTab.style.display = 'none';
                }
            }
        }

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            
            if (!user) {
                showScreen('loginScreen');
                if (notesUnsubscribe) notesUnsubscribe();
                if (allNotesUnsubscribe) allNotesUnsubscribe();
                if (usersUnsubscribe) usersUnsubscribe();
                currentUserRole = 'user';
            } else {
                document.getElementById('userEmail').textContent = user.email;
                const myTransactionsEmail = document.getElementById('myTransactionsUserEmail');
                if (myTransactionsEmail) {
                    myTransactionsEmail.textContent = user.email;
                }
                
                // Z√≠skat roli u≈æivatele
                currentUserRole = await getUserRole(user.uid);
                
                // Pokud u≈æivatel nem√° roli, zobrazit pr√°zdnou obrazovku
                if (!currentUserRole) {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    let displayName;
                    if (userDoc.exists() && userDoc.data().email) {
                        displayName = userDoc.data().email;
                    } else {
                        if (user.email && user.email.endsWith('@local.local')) {
                            displayName = user.email.replace('@local.local', '');
                        } else {
                            displayName = user.email || 'U≈æivatel';
                        }
                    }
                    document.getElementById('waitingUserEmail').textContent = displayName;
                    showScreen('waitingForRoleScreen');
                    // Nastavit listener pro zmƒõny role (real-time aktualizace)
                    const userDocRef = doc(db, 'users', user.uid);
                    const unsubscribe = onSnapshot(userDocRef, async (snapshot) => {
                        if (snapshot.exists()) {
                            const role = snapshot.data().role;
                            if (role) {
                                // U≈æivatel dostal roli - znovu naƒç√≠st
                                currentUserRole = role;
                                // Zavolat auth state listener znovu
                                const currentUser = auth.currentUser;
                                if (currentUser) {
                                    // Znovu spustit logiku pro p≈ôihl√°≈°en√©ho u≈æivatele
                                    const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                                    const displayName = userDoc.exists() && userDoc.data().email ? userDoc.data().email : (currentUser.email || 'U≈æivatel');
                                    document.getElementById('userEmail').textContent = displayName;
                                    updateStockFormForRole(currentUserRole);
                                    
                                    if (currentUserRole === 'admin' || currentUserRole === 'moderator') {
                                        document.getElementById('adminBtn').classList.remove('hidden');
                                        updateAdminTabsVisibility();
                                        const usersTab = document.getElementById('adminTabUsers');
                                        if (currentUserRole === 'admin') {
                                            usersTab.style.display = 'inline-block';
                                        } else {
                                            usersTab.style.display = 'none';
                                        }
                                    } else {
                                        document.getElementById('adminBtn').classList.add('hidden');
                                    }
                                    
                                    showScreen('notesScreen');
                                    loadStockStatus();
                                    unsubscribe(); // Zastavit listener
                                }
                            }
                        }
                    });
                    return; // Ukonƒçit funkci, u≈æivatel nem√° roli
                }
                
                // Aktualizovat formul√°≈ô podle role
                updateStockFormForRole(currentUserRole);
                
                // Zobrazit admin panel podle role
                if (currentUserRole === 'admin' || currentUserRole === 'moderator') {
                    document.getElementById('adminBtn').classList.remove('hidden');
                    
                // Zobrazit tab pro spr√°vu rol√≠ pouze pro adminy a moder√°tory
                updateAdminTabsVisibility();
                
                // Zobrazit tab pro spr√°vu u≈æivatel≈Ø pouze pro adminy
                const usersTab = document.getElementById('adminTabUsers');
                if (currentUserRole === 'admin') {
                    usersTab.style.display = 'inline-block';
                } else {
                    usersTab.style.display = 'none';
                }
                } else {
                    document.getElementById('adminBtn').classList.add('hidden');
                }
                
                showScreen('notesScreen');
                loadStockStatus();
            }
        });
    </script>
</body>
</html>


